<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ãŠå°é£ã„è¨˜éŒ²å¸³</title>
  <style>
    :root{
      --bg:#f7f7ff;
      --card:#ffffff;
      --ink:#1f2330;
      --muted: rgba(31,35,48,.65);
      --line: rgba(0,0,0,.10);
      --shadow: 0 10px 22px rgba(0,0,0,.10);
      --radius: 18px;

      --good:#22c55e;
      --bad:#ef4444;
      --blue:#4f46e5;
      --orange:#f97316;
      --pink:#ec4899;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family: system-ui,-apple-system,"Noto Sans JP",sans-serif;
      background: radial-gradient(circle at 12% 10%, rgba(79,70,229,.10), transparent 40%),
                  radial-gradient(circle at 95% 20%, rgba(236,72,153,.12), transparent 40%),
                  radial-gradient(circle at 20% 95%, rgba(249,115,22,.10), transparent 40%),
                  var(--bg);
      color:var(--ink);
      padding-bottom: 110px;
    }
    .wrap{max-width:720px;margin:0 auto;padding:16px 14px 40px;}
    .top{display:flex;align-items:center;gap:10px;margin:8px 0 12px;}
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: linear-gradient(135deg,var(--blue),var(--pink));
      color:#fff;font-weight:1000;
      display:grid;place-items:center;
      box-shadow: var(--shadow);
      user-select:none;
    }
    h1{margin:0;font-size:20px;}
    .sub{margin-top:2px;font-size:12px;color:var(--muted);}

    .card{
      background:var(--card);
      border-radius:var(--radius);
      border:2px solid rgba(255,255,255,.7);
      box-shadow: var(--shadow);
      padding:14px;
      margin: 12px 0;
    }
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .rowNowrap{display:flex;gap:10px;align-items:center;flex-wrap:nowrap;}
    .grow{flex:1;}
    .titleRow{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px;}
    .titleRow .title{font-weight:1000;}
    .pill{
      padding:7px 10px;border-radius:999px;border:2px solid rgba(0,0,0,.10);
      background:#fff;font-weight:1000;font-size:12px;cursor:pointer;
      user-select:none;
    }
    .pill.active{
      border-color: rgba(79,70,229,.45);
      box-shadow: 0 0 0 4px rgba(79,70,229,.14);
    }

    input, select, textarea{
      width:100%;
      padding:12px;
      border-radius:14px;
      border:2px solid rgba(0,0,0,.10);
      outline:none;
      background:#fff;
      font-size:15px;
    }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(79,70,229,.45);
      box-shadow: 0 0 0 4px rgba(79,70,229,.14);
    }

    .btn{
      border:none;
      border-radius:14px;
      padding:12px 12px;
      font-weight:1000;
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
      white-space:nowrap;
    }
    .btnPrimary{
      background: linear-gradient(135deg,var(--blue),#7c3aed);
      color:#fff;
      box-shadow:0 10px 18px rgba(0,0,0,.14);
    }
    .btnGhost{
      background:#fff;
      border:2px solid rgba(0,0,0,.10);
      box-shadow:none;
      color:#111;
    }
    .btnDanger{
      background: rgba(239,68,68,.10);
      border:2px solid rgba(239,68,68,.22);
      box-shadow:none;
      color:#b91c1c;
    }

    .kpiGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    @media(min-width:640px){ .kpiGrid{grid-template-columns:1fr 1fr 1fr 1fr;} }
    .kpi{
      border-radius:16px;
      padding:10px;
      border:2px solid rgba(0,0,0,.08);
      background: rgba(0,0,0,.02);
      text-align:center;
      font-weight:1000;
    }
    .kpi .val{display:block;margin-top:6px;font-size:18px;}
    .kpi.good{background: rgba(34,197,94,.10); border-color: rgba(34,197,94,.22);}
    .kpi.bad{background: rgba(239,68,68,.08); border-color: rgba(239,68,68,.20);}
    .kpi.blue{background: rgba(79,70,229,.08); border-color: rgba(79,70,229,.18);}

    ul{list-style:none;padding:0;margin:0;display:grid;gap:10px;}
    .item{
      display:flex;gap:10px;align-items:flex-start;
      padding:12px;border-radius:16px;
      background: rgba(0,0,0,.03);
      border:2px solid rgba(0,0,0,.06);
    }
    .item .main{flex:1;}
    .item .head{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
    .badgeType{
      display:inline-flex;align-items:center;gap:6px;
      padding:5px 10px;border-radius:999px;
      border:2px solid rgba(0,0,0,.10);
      background:#fff;font-weight:1000;font-size:12px;
    }
    .badgeType.in{border-color: rgba(34,197,94,.28); background: rgba(34,197,94,.10);}
    .badgeType.out{border-color: rgba(239,68,68,.22); background: rgba(239,68,68,.08);}
    .badgeType.chore{border-color: rgba(79,70,229,.22); background: rgba(79,70,229,.08);}
    .desc{font-weight:1000;font-size:16px;line-height:1.25;}
    .meta{margin-top:6px;color:var(--muted);font-size:12px;font-weight:800;}
    .amt{font-weight:1000;font-size:16px;white-space:nowrap;}
    .amt.plus{color: var(--good);}
    .amt.minus{color: var(--bad);}
    .actions{display:flex;gap:6px;flex:0 0 auto;align-items:center;}

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform: translateX(-50%);
      background: rgba(0,0,0,.86);
      color:#fff;
      padding:10px 12px;
      border-radius:999px;
      font-weight:1000;
      font-size:13px;
      opacity:0;
      pointer-events:none;
      transition: opacity .2s ease, transform .2s ease;
      z-index:999;
    }
    .toast.show{opacity:1;transform: translateX(-50%) translateY(-2px);}

    .backBar{
      position:fixed;
      left:0; right:0; bottom:0;
      padding: 12px 12px calc(12px + env(safe-area-inset-bottom));
      background: rgba(255,255,255,.88);
      backdrop-filter: blur(10px);
      border-top: 2px solid rgba(0,0,0,.08);
      z-index: 998;
    }
    .backBtn{
      display:block;
      max-width:720px;
      margin:0 auto;
      text-decoration:none;
      text-align:center;
      padding: 14px 12px;
      border-radius: 16px;
      font-weight: 950;
      color:#fff;
      background: linear-gradient(135deg, var(--blue), #7c3aed);
      box-shadow: var(--shadow);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="logo">Â¥</div>
      <div>
        <h1>ãŠå°é£ã„è¨˜éŒ²å¸³</h1>
        <div class="sub">å®¶æ—ã§å…±æœ‰OKï¼ˆGASåŒæœŸï¼‰</div>
      </div>
    </div>

    <div class="card">
      <div class="titleRow">
        <div class="title">ğŸ“Š é›†è¨ˆ</div>
        <div class="rowNowrap" style="gap:8px;">
          <select id="rangeSel" style="max-width:220px;">
            <option value="all">ã™ã¹ã¦</option>
            <option value="thisMonth">ä»Šæœˆ</option>
            <option value="lastMonth">å…ˆæœˆ</option>
            <option value="thisYear">ä»Šå¹´</option>
          </select>
        </div>
      </div>
      <div class="kpiGrid">
        <div class="kpi good">
          åå…¥<span class="val" id="kpiIn">Â¥0</span>
        </div>
        <div class="kpi bad">
          æ”¯å‡º<span class="val" id="kpiOut">Â¥0</span>
        </div>
        <div class="kpi blue">
          æ®‹é«˜<span class="val" id="kpiBal">Â¥0</span>
        </div>
        <div class="kpi">
          è¨˜éŒ²æ•°<span class="val" id="kpiCnt">0</span>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="titleRow">
        <div class="title">â• è¿½åŠ </div>
        <div class="row" style="gap:8px;">
          <button class="pill active" id="tabChore">ğŸ§¹ ãŠæ‰‹ä¼ã„</button>
          <button class="pill" id="tabIncome">ğŸ’° åå…¥</button>
          <button class="pill" id="tabExpense">ğŸ›’ æ”¯å‡º</button>
        </div>
      </div>

      <div class="row">
        <div class="grow">
          <label style="font-weight:1000;font-size:12px;color:var(--muted);">æ—¥ä»˜</label>
          <input id="date" type="date" />
        </div>
        <div class="grow">
          <label style="font-weight:1000;font-size:12px;color:var(--muted);">1å›ã®é‡‘é¡ï¼ˆãŠæ‰‹ä¼ã„ç”¨ï¼‰</label>
          <input id="unitPrice" type="number" inputmode="numeric" placeholder="ä¾‹ï¼š50" />
        </div>
      </div>

      <div class="row">
        <div class="grow">
          <label style="font-weight:1000;font-size:12px;color:var(--muted);">å†…å®¹</label>
          <input id="desc" type="text" maxlength="40" placeholder="ä¾‹ï¼šãŠçš¿æ´—ã„ / ãŠå¹´ç‰ / ãŠã‚„ã¤" />
        </div>
        <div class="grow" style="max-width:220px;">
          <label style="font-weight:1000;font-size:12px;color:var(--muted);">é‡‘é¡ï¼ˆåå…¥/æ”¯å‡ºï¼‰</label>
          <input id="amount" type="number" inputmode="numeric" placeholder="ä¾‹ï¼š100" />
        </div>
      </div>

      <div class="row">
        <button class="btn btnPrimary" id="addBtn">ï¼‹ è¨˜éŒ²ã™ã‚‹</button>
        <button class="btn btnGhost" id="clearBtn">ğŸ§½ å…¥åŠ›ã‚¯ãƒªã‚¢</button>
        <button class="btn btnDanger" id="wipeBtn">ğŸ§¹ å…¨æ¶ˆå»</button>
      </div>
    </div>

    <div class="card">
      <div class="titleRow">
        <div class="title">ğŸ“’ è¨˜éŒ²ä¸€è¦§</div>
      </div>
      <ul id="list"></ul>
    </div>

  </div>

  <div class="toast" id="toast">ä¿å­˜ã—ãŸã‚ˆï¼</div>
  <div class="backBar"><a class="backBtn" href="index.html">ğŸ  ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</a></div>

<script>
(() => {
  // ===== å…±æœ‰ã‚µãƒ¼ãƒãƒ¼ï¼ˆGASï¼‰åŒæœŸï¼ˆmode=load/saveç‰ˆï¼‰=====
  const API_URL = "https://script.google.com/macros/s/AKfycbxVT20cF2cEQwbXWEn4_MlvKBDAq9YTW6mcewmPz8imWyrR39MnuqdPxQ9ZXO9Q91JG/exec";
  const API_TOKEN = "kids-2026-0130-asahi-0620"; // â† Code.gs ã¨åŒã˜åˆè¨€è‘‰

  async function apiPost(payload){
    try{
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({ token: API_TOKEN, ...payload })
      });
      return await res.json();
    }catch(err){
      return { ok:false, error: String(err?.message || err) };
    }
  }

  async function remoteGet(key){
    try{
      const url = `${API_URL}?mode=load&token=${encodeURIComponent(API_TOKEN)}&key=${encodeURIComponent(key)}`;
      const res = await fetch(url);
      const j = await res.json();
      return (j && j.ok) ? j.data : null;
    }catch{
      return null;
    }
  }

  async function remoteSet(key, value){
    await apiPost({ mode:"save", key, data: value });
  }

  // ===== safe localStorage =====
  const KEY = "allowance_book_v1";
  const KEY_UNIT = "allowance_unit_v1";

  function makeId(){
    if(typeof crypto !== "undefined" && typeof crypto.randomUUID === "function") return crypto.randomUUID();
    return "id-" + Math.random().toString(16).slice(2) + "-" + Date.now().toString(16);
  }

  function canUseStorage(){
    try{
      const k = "__t__" + makeId();
      localStorage.setItem(k, "1");
      localStorage.removeItem(k);
      return true;
    }catch{
      return false;
    }
  }
  const STORAGE_OK = canUseStorage();
  const memStore = {};

  function loadJson(key){
    try{
      if(STORAGE_OK){
        const raw = localStorage.getItem(key);
        return raw ? JSON.parse(raw) : null;
      }else{
        return (key in memStore) ? memStore[key] : null;
      }
    }catch{
      return null;
    }
  }

  function saveJson(key, value){
    try{
      if(STORAGE_OK){
        localStorage.setItem(key, JSON.stringify(value));
      }else{
        memStore[key] = value;
      }
    }catch{}
  }

  function fmtYen(n){
    const v = Math.trunc(Number(n) || 0);
    return "Â¥" + v.toLocaleString();
  }
  function num(v){ return Number(v || 0); }
  function todayISO(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${dd}`;
  }

  // ===== state =====
  let entries = loadJson(KEY);
  if(!Array.isArray(entries)) entries = [];
  entries = entries.filter(x => x && x.id && x.date && x.type).map(x => ({
    id: String(x.id),
    date: String(x.date),
    type: (x.type === "chore" || x.type === "in" || x.type === "out") ? x.type : "in",
    desc: String(x.desc || "").slice(0,40),
    amount: Math.trunc(num(x.amount))
  }));

  let unitPrice = loadJson(KEY_UNIT);
  if(typeof unitPrice !== "number") unitPrice = 50;
  unitPrice = Math.max(0, Math.trunc(unitPrice));

  let mode = "chore";
  let range = "all";

  // ===== DOM =====
  const el = {
    tabChore: document.getElementById("tabChore"),
    tabIncome: document.getElementById("tabIncome"),
    tabExpense: document.getElementById("tabExpense"),
    date: document.getElementById("date"),
    unitPrice: document.getElementById("unitPrice"),
    desc: document.getElementById("desc"),
    amount: document.getElementById("amount"),
    addBtn: document.getElementById("addBtn"),
    clearBtn: document.getElementById("clearBtn"),
    wipeBtn: document.getElementById("wipeBtn"),
    list: document.getElementById("list"),
    rangeSel: document.getElementById("rangeSel"),
    kpiIn: document.getElementById("kpiIn"),
    kpiOut: document.getElementById("kpiOut"),
    kpiBal: document.getElementById("kpiBal"),
    kpiCnt: document.getElementById("kpiCnt"),
    toast: document.getElementById("toast"),
  };

  function toast(msg){
    el.toast.textContent = msg;
    el.toast.classList.add("show");
    clearTimeout(toast._t);
    toast._t = setTimeout(() => el.toast.classList.remove("show"), 950);
  }

  function setMode(next){
    mode = next;
    el.tabChore.classList.toggle("active", mode === "chore");
    el.tabIncome.classList.toggle("active", mode === "in");
    el.tabExpense.classList.toggle("active", mode === "out");

    if(mode === "chore"){
      el.amount.value = String(unitPrice);
      el.amount.disabled = true;
      el.amount.style.opacity = ".7";
    }else{
      el.amount.disabled = false;
      el.amount.style.opacity = "1";
      el.amount.value = "";
    }
    el.desc.focus();
  }

  function withinRange(dateStr){
    if(range === "all") return true;
    const d = new Date(dateStr);
    const now = new Date();
    const y = now.getFullYear();
    const m = now.getMonth();

    if(range === "thisMonth"){
      return d.getFullYear() === y && d.getMonth() === m;
    }
    if(range === "lastMonth"){
      const lm = new Date(y, m-1, 1);
      return d.getFullYear() === lm.getFullYear() && d.getMonth() === lm.getMonth();
    }
    if(range === "thisYear"){
      return d.getFullYear() === y;
    }
    return true;
  }

  function calc(){
    const list = entries.filter(e => withinRange(e.date));
    let sumIn = 0, sumOut = 0;
    for(const e of list){
      if(e.type === "out") sumOut += Math.abs(e.amount);
      else sumIn += Math.abs(e.amount);
    }
    const bal = sumIn - sumOut;
    return { sumIn, sumOut, bal, count: list.length, list };
  }

  function render(){
    if(!el.date.value) el.date.value = todayISO();
    el.unitPrice.value = String(unitPrice);

    const { sumIn, sumOut, bal, count, list } = calc();
    el.kpiIn.textContent = fmtYen(sumIn);
    el.kpiOut.textContent = fmtYen(sumOut);
    el.kpiBal.textContent = fmtYen(bal);
    el.kpiCnt.textContent = String(count);

    el.list.innerHTML = "";
    if(list.length === 0){
      const li = document.createElement("li");
      li.className = "item";
      li.innerHTML = `<div class="main"><div class="desc">ã¾ã è¨˜éŒ²ãŒãªã„ã‚ˆ</div><div class="meta">ä¸Šã®ã€Œè¿½åŠ ã€ã‹ã‚‰å…¥ã‚Œã¦ã­</div></div>`;
      el.list.appendChild(li);
      return;
    }

    const sorted = [...list].sort((a,b) => {
      if(a.date === b.date) return (a.id > b.id ? -1 : 1);
      return a.date > b.date ? -1 : 1;
    });

    for(const e of sorted){
      const li = document.createElement("li");
      li.className = "item";

      const typeLabel =
        e.type === "chore" ? "ğŸ§¹ ãŠæ‰‹ä¼ã„" :
        e.type === "in"    ? "ğŸ’° åå…¥" :
                             "ğŸ›’ æ”¯å‡º";
      const badgeClass =
        e.type === "chore" ? "chore" :
        e.type === "in"    ? "in" :
                             "out";

      const amt = Math.abs(Math.trunc(num(e.amount)));
      const isOut = (e.type === "out");
      const amtTxt = (isOut ? "-" : "+") + fmtYen(amt).replace("Â¥","Â¥");
      const amtClass = isOut ? "minus" : "plus";
      const desc = (e.desc || "").trim() || (e.type === "out" ? "ï¼ˆæ”¯å‡ºï¼‰" : e.type === "in" ? "ï¼ˆåå…¥ï¼‰" : "ï¼ˆãŠæ‰‹ä¼ã„ï¼‰");

      li.innerHTML = `
        <div class="main">
          <div class="head">
            <span class="badgeType ${badgeClass}">${typeLabel}</span>
            <span class="amt ${amtClass}">${amtTxt}</span>
          </div>
          <div class="desc">${escapeHtml(desc)}</div>
          <div class="meta">æ—¥ä»˜ï¼š${new Date(e.date).toLocaleDateString()}</div>
        </div>
        <div class="actions">
          <button class="pill" data-act="del" title="å‰Šé™¤">ğŸ—‘</button>
        </div>
      `;

      li.querySelector('[data-act="del"]').addEventListener("click", () => {
        entries = entries.filter(x => x.id !== e.id);
        saveJson(KEY, entries);
        remoteSet(KEY, entries);
        remoteSet(KEY_UNIT, unitPrice);
        toast(STORAGE_OK ? "å‰Šé™¤ã—ãŸã‚ˆ" : "ä¿å­˜ã§ããªã„ç’°å¢ƒã‹ã‚‚");
        render();
      });

      el.list.appendChild(li);
    }
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function clearInputs(){
    el.desc.value = "";
    el.amount.value = (mode === "chore") ? String(unitPrice) : "";
    toast("å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢ã—ãŸã‚ˆ");
    el.desc.focus();
  }

  function addEntry(){
    const date = el.date.value || todayISO();
    const desc = String(el.desc.value || "").trim().slice(0,40);

    if(mode === "chore"){
      const amount = Math.max(0, Math.trunc(num(unitPrice)));
      entries.push({ id: makeId(), date, type:"chore", desc: desc || "ï¼ˆãŠæ‰‹ä¼ã„ï¼‰", amount });
    }else if(mode === "in"){
      const amount = Math.max(0, Math.trunc(num(el.amount.value)));
      if(!amount){ toast("é‡‘é¡ã‚’å…¥ã‚Œã¦ã­"); el.amount.focus(); return; }
      entries.push({ id: makeId(), date, type:"in", desc: desc || "ï¼ˆåå…¥ï¼‰", amount });
    }else{
      const amount = Math.max(0, Math.trunc(num(el.amount.value)));
      if(!amount){ toast("é‡‘é¡ã‚’å…¥ã‚Œã¦ã­"); el.amount.focus(); return; }
      entries.push({ id: makeId(), date, type:"out", desc: desc || "ï¼ˆæ”¯å‡ºï¼‰", amount });
    }

    saveJson(KEY, entries);
    remoteSet(KEY, entries);
    remoteSet(KEY_UNIT, unitPrice);
    toast(STORAGE_OK ? "è¿½åŠ ã—ãŸã‚ˆï¼" : "ä¿å­˜ã§ããªã„ç’°å¢ƒã‹ã‚‚");

    el.desc.value = "";
    el.amount.value = (mode === "chore") ? String(unitPrice) : "";
    render();
  }

  function wipeAll(){
    const ok = confirm("å…¨éƒ¨æ¶ˆã—ã¾ã™ã€‚ã»ã‚“ã¨ã†ã«OKï¼Ÿ");
    if(!ok) return;
    entries = [];
    saveJson(KEY, entries);
    remoteSet(KEY, entries);
    toast("å…¨éƒ¨æ¶ˆã—ãŸã‚ˆ");
    render();
  }

  // ===== events =====
  el.tabChore.addEventListener("click", () => setMode("chore"));
  el.tabIncome.addEventListener("click", () => setMode("in"));
  el.tabExpense.addEventListener("click", () => setMode("out"));

  el.addBtn.addEventListener("click", addEntry);
  el.clearBtn.addEventListener("click", clearInputs);
  el.wipeBtn.addEventListener("click", wipeAll);

  el.rangeSel.addEventListener("change", () => {
    range = el.rangeSel.value;
    render();
  });

  el.unitPrice.addEventListener("change", () => {
    const v = Math.max(0, Math.trunc(num(el.unitPrice.value)));
    unitPrice = v;
    saveJson(KEY_UNIT, unitPrice);
    remoteSet(KEY_UNIT, unitPrice);
    if(mode === "chore") el.amount.value = String(unitPrice);
    render();
    toast("1å›ã®é‡‘é¡ã‚’ä¿å­˜ã—ãŸã‚ˆ");
  });

  // ===== init =====
  (async () => {
    el.date.value = todayISO();
    setMode("chore");
    render();

    // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–ã‚Šè¾¼ã¿ï¼ˆã‚ã‚Œã°ä¸Šæ›¸ãï¼‰
    const remoteEntries = await remoteGet(KEY);
    if(Array.isArray(remoteEntries)){
      entries = remoteEntries;
      saveJson(KEY, entries);
    }
    const remoteUnit = await remoteGet(KEY_UNIT);
    if(typeof remoteUnit === "number"){
      unitPrice = remoteUnit;
      saveJson(KEY_UNIT, unitPrice);
    }
    if(mode === "chore") el.amount.value = String(unitPrice);

    render();
  })();
})();
</script>
</body>
</html>
