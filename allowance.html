<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ãŠå°é£ã„è¨˜éŒ²å¸³</title>
  <style>
    :root{
      --bg:#f7f7ff; --card:#ffffff; --ink:#1f2330;
      --muted: rgba(31,35,48,.65); --shadow: 0 10px 22px rgba(0,0,0,.10);
      --radius: 18px; --good:#22c55e; --bad:#ef4444; --blue:#4f46e5; --pink:#ec4899;
    }
    *{box-sizing:border-box;}
    body{
      margin:0; font-family: system-ui,-apple-system,"Noto Sans JP",sans-serif;
      background: radial-gradient(circle at 12% 10%, rgba(79,70,229,.10), transparent 40%),
                  radial-gradient(circle at 95% 20%, rgba(236,72,153,.12), transparent 40%),
                  var(--bg);
      color:var(--ink); padding-bottom: 110px;
    }
    .wrap{max-width:720px;margin:0 auto;padding:16px 14px 40px;}
    .top{display:flex;align-items:center;gap:10px;margin:8px 0 12px;}
    .logo{width:44px;height:44px;border-radius:14px;background:linear-gradient(135deg,var(--blue),var(--pink));color:#fff;font-weight:1000;display:grid;place-items:center;box-shadow:var(--shadow);}
    h1{margin:0;font-size:20px;}
    .sub{margin-top:2px;font-size:12px;color:var(--muted);}
    .card{background:var(--card);border-radius:var(--radius);border:2px solid rgba(255,255,255,.7);box-shadow:var(--shadow);padding:14px;margin:12px 0;}
    .titleRow{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px;}
    .titleRow .title{font-weight:1000;}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .grow{flex:1;}
    input, select{width:100%;padding:12px;border-radius:14px;border:2px solid rgba(0,0,0,.10);outline:none;background:#fff;font-size:15px;}
    input:focus, select:focus{border-color: rgba(79,70,229,.45);box-shadow:0 0 0 4px rgba(79,70,229,.14);}
    .pill{padding:7px 10px;border-radius:999px;border:2px solid rgba(0,0,0,.10);background:#fff;font-weight:1000;font-size:12px;cursor:pointer;}
    .pill.active{border-color: rgba(79,70,229,.45);box-shadow:0 0 0 4px rgba(79,70,229,.14);}
    .btn{border:none;border-radius:14px;padding:12px 12px;font-weight:1000;cursor:pointer;user-select:none;white-space:nowrap;}
    .btnPrimary{background:linear-gradient(135deg,var(--blue),#7c3aed);color:#fff;box-shadow:0 10px 18px rgba(0,0,0,.14);}
    .btnGhost{background:#fff;border:2px solid rgba(0,0,0,.10);box-shadow:none;}
    .btnDanger{background:rgba(239,68,68,.10);border:2px solid rgba(239,68,68,.22);box-shadow:none;color:#b91c1c;}
    .kpiGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    @media(min-width:640px){ .kpiGrid{grid-template-columns:1fr 1fr 1fr 1fr;} }
    .kpi{border-radius:16px;padding:10px;border:2px solid rgba(0,0,0,.08);background:rgba(0,0,0,.02);text-align:center;font-weight:1000;}
    .kpi .val{display:block;margin-top:6px;font-size:18px;}
    .kpi.good{background:rgba(34,197,94,.10);border-color:rgba(34,197,94,.22);}
    .kpi.bad{background:rgba(239,68,68,.08);border-color:rgba(239,68,68,.20);}
    .kpi.blue{background:rgba(79,70,229,.08);border-color:rgba(79,70,229,.18);}
    ul{list-style:none;padding:0;margin:0;display:grid;gap:10px;}
    .item{display:flex;gap:10px;align-items:flex-start;padding:12px;border-radius:16px;background:rgba(0,0,0,.03);border:2px solid rgba(0,0,0,.06);}
    .item .main{flex:1;}
    .badgeType{display:inline-flex;align-items:center;gap:6px;padding:5px 10px;border-radius:999px;border:2px solid rgba(0,0,0,.10);background:#fff;font-weight:1000;font-size:12px;}
    .badgeType.in{border-color:rgba(34,197,94,.28);background:rgba(34,197,94,.10);}
    .badgeType.out{border-color:rgba(239,68,68,.22);background:rgba(239,68,68,.08);}
    .badgeType.chore{border-color:rgba(79,70,229,.22);background:rgba(79,70,229,.08);}
    .desc{font-weight:1000;font-size:16px;line-height:1.25;}
    .meta{margin-top:6px;color:var(--muted);font-size:12px;font-weight:800;}
    .amt{font-weight:1000;font-size:16px;white-space:nowrap;}
    .amt.plus{color:var(--good);} .amt.minus{color:var(--bad);}
    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:rgba(0,0,0,.86);color:#fff;padding:10px 12px;border-radius:999px;font-weight:1000;font-size:13px;opacity:0;pointer-events:none;transition:opacity .2s ease, transform .2s ease;z-index:999;}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(-2px);}
    .backBar{position:fixed;left:0; right:0; bottom:0;padding:12px 12px calc(12px + env(safe-area-inset-bottom));background:rgba(255,255,255,.88);backdrop-filter:blur(10px);border-top:2px solid rgba(0,0,0,.08);z-index:998;}
    .backBtn{display:block;max-width:720px;margin:0 auto;text-decoration:none;text-align:center;padding:14px 12px;border-radius:16px;font-weight:950;color:#fff;background:linear-gradient(135deg,var(--blue),#7c3aed);box-shadow:var(--shadow);}
    .syncHint{font-size:12px;color:var(--muted);font-weight:900;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="logo">Â¥</div>
      <div>
        <h1>ãŠå°é£ã„è¨˜éŒ²å¸³</h1>
        <div class="sub">å®¶æ—ã§å…±æœ‰OKï¼ˆè‡ªå‹•æ›´æ–°ï¼š2ç§’ï¼‰</div>
      </div>
    </div>

    <div class="card">
      <div class="titleRow">
        <div class="title">ğŸ“Š é›†è¨ˆ</div>
        <select id="rangeSel" style="max-width:220px;">
          <option value="all">ã™ã¹ã¦</option>
          <option value="thisMonth">ä»Šæœˆ</option>
          <option value="lastMonth">å…ˆæœˆ</option>
          <option value="thisYear">ä»Šå¹´</option>
        </select>
      </div>
      <div class="kpiGrid">
        <div class="kpi good">åå…¥<span class="val" id="kpiIn">Â¥0</span></div>
        <div class="kpi bad">æ”¯å‡º<span class="val" id="kpiOut">Â¥0</span></div>
        <div class="kpi blue">æ®‹é«˜<span class="val" id="kpiBal">Â¥0</span></div>
        <div class="kpi">è¨˜éŒ²æ•°<span class="val" id="kpiCnt">0</span></div>
      </div>
      <div class="syncHint" id="syncHint">ğŸ”„ åŒæœŸï¼šå¾…æ©Ÿä¸­</div>
    </div>

    <div class="card">
      <div class="titleRow">
        <div class="title">â• è¿½åŠ </div>
        <div class="row" style="gap:8px;">
          <button class="pill active" id="tabChore">ğŸ§¹ ãŠæ‰‹ä¼ã„</button>
          <button class="pill" id="tabIncome">ğŸ’° åå…¥</button>
          <button class="pill" id="tabExpense">ğŸ›’ æ”¯å‡º</button>
        </div>
      </div>

      <div class="row">
        <div class="grow">
          <label style="font-weight:1000;font-size:12px;color:var(--muted);">æ—¥ä»˜</label>
          <input id="date" type="date" />
        </div>
        <div class="grow">
          <label style="font-weight:1000;font-size:12px;color:var(--muted);">1å›ã®é‡‘é¡ï¼ˆãŠæ‰‹ä¼ã„ç”¨ï¼‰</label>
          <input id="unitPrice" type="number" inputmode="numeric" placeholder="ä¾‹ï¼š50" />
        </div>
      </div>

      <div class="row">
        <div class="grow">
          <label style="font-weight:1000;font-size:12px;color:var(--muted);">å†…å®¹</label>
          <input id="desc" type="text" maxlength="40" placeholder="ä¾‹ï¼šãŠçš¿æ´—ã„ / ãŠå¹´ç‰ / ãŠã‚„ã¤" />
        </div>
        <div class="grow" style="max-width:220px;">
          <label style="font-weight:1000;font-size:12px;color:var(--muted);">é‡‘é¡ï¼ˆåå…¥/æ”¯å‡ºï¼‰</label>
          <input id="amount" type="number" inputmode="numeric" placeholder="ä¾‹ï¼š100" />
        </div>
      </div>

      <div class="row">
        <button class="btn btnPrimary" id="addBtn">ï¼‹ è¨˜éŒ²ã™ã‚‹</button>
        <button class="btn btnGhost" id="clearBtn">ğŸ§½ å…¥åŠ›ã‚¯ãƒªã‚¢</button>
        <button class="btn btnDanger" id="wipeBtn">ğŸ§¹ å…¨æ¶ˆå»</button>
        <button class="btn btnGhost" id="syncBtn">ğŸ”„ å…±æœ‰ã‚’æ›´æ–°</button>
      </div>
    </div>

    <div class="card">
      <div class="titleRow"><div class="title">ğŸ“’ è¨˜éŒ²ä¸€è¦§</div></div>
      <ul id="list"></ul>
    </div>
  </div>

  <div class="toast" id="toast">ä¿å­˜ã—ãŸã‚ˆï¼</div>
  <div class="backBar"><a class="backBtn" href="index.html">ğŸ  ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</a></div>

<script>
(() => {
  // ===== GASï¼ˆmode=load/saveï¼‰=====
  const API_URL = "https://script.google.com/macros/s/AKfycbxVT20cF2cEQwbXWEn4_MlvKBDAq9YTW6mcewmPz8imWyrR39MnuqdPxQ9ZXO9Q91JG/exec";
  const API_TOKEN = "kids-2026-0130-asahi-0620";

  async function apiPost(payload){
    try{
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({ token: API_TOKEN, ...payload })
      });
      return await res.json();
    }catch(err){
      return { ok:false, error: String(err?.message || err) };
    }
  }

  async function remoteGet(key){
    try{
      const url = `${API_URL}?mode=load&token=${encodeURIComponent(API_TOKEN)}&key=${encodeURIComponent(key)}`;
      const res = await fetch(url, { cache:"no-store" });
      const j = await res.json();
      return (j && j.ok) ? j.data : null;
    }catch{
      return null;
    }
  }

  async function remoteSet(key, value){
    return await apiPost({ mode:"save", key, data: value });
  }

  const KEY = "allowance_book_v1";
  const KEY_UNIT = "allowance_unit_v1";

  function makeId(){
    if(typeof crypto !== "undefined" && typeof crypto.randomUUID === "function") return crypto.randomUUID();
    return "id-" + Math.random().toString(16).slice(2) + "-" + Date.now().toString(16);
  }
  function fmtYen(n){ return "Â¥" + Math.trunc(Number(n)||0).toLocaleString(); }
  function num(v){ return Number(v || 0); }
  function todayISO(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${dd}`;
  }
  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  // state
  let entries = [];
  let unitPrice = 50;
  let mode = "chore";
  let range = "all";
  let saving = false;

  let lastSigEntries = "";
  let lastSigUnit = "";

  const el = {
    tabChore: document.getElementById("tabChore"),
    tabIncome: document.getElementById("tabIncome"),
    tabExpense: document.getElementById("tabExpense"),
    date: document.getElementById("date"),
    unitPrice: document.getElementById("unitPrice"),
    desc: document.getElementById("desc"),
    amount: document.getElementById("amount"),
    addBtn: document.getElementById("addBtn"),
    clearBtn: document.getElementById("clearBtn"),
    wipeBtn: document.getElementById("wipeBtn"),
    syncBtn: document.getElementById("syncBtn"),
    list: document.getElementById("list"),
    rangeSel: document.getElementById("rangeSel"),
    kpiIn: document.getElementById("kpiIn"),
    kpiOut: document.getElementById("kpiOut"),
    kpiBal: document.getElementById("kpiBal"),
    kpiCnt: document.getElementById("kpiCnt"),
    toast: document.getElementById("toast"),
    syncHint: document.getElementById("syncHint"),
  };

  function toast(msg){
    el.toast.textContent = msg;
    el.toast.classList.add("show");
    clearTimeout(toast._t);
    toast._t = setTimeout(() => el.toast.classList.remove("show"), 1200);
  }
  function setHint(msg){ el.syncHint.textContent = msg; }

  function sigOf(obj){
    try{ return JSON.stringify(obj).length + ":" + (Array.isArray(obj)?obj.length:0) + ":" + (obj?.[0]?.id ?? ""); }
    catch{ return String(Date.now()); }
  }

  function setMode(next){
    mode = next;
    el.tabChore.classList.toggle("active", mode === "chore");
    el.tabIncome.classList.toggle("active", mode === "in");
    el.tabExpense.classList.toggle("active", mode === "out");

    if(mode === "chore"){
      el.amount.value = String(unitPrice);
      el.amount.disabled = true;
      el.amount.style.opacity = ".7";
    }else{
      el.amount.disabled = false;
      el.amount.style.opacity = "1";
      el.amount.value = "";
    }
    el.desc.focus();
  }

  function withinRange(dateStr){
    if(range === "all") return true;
    const d = new Date(dateStr);
    const now = new Date();
    const y = now.getFullYear();
    const m = now.getMonth();
    if(range === "thisMonth") return d.getFullYear() === y && d.getMonth() === m;
    if(range === "lastMonth"){
      const lm = new Date(y, m-1, 1);
      return d.getFullYear() === lm.getFullYear() && d.getMonth() === lm.getMonth();
    }
    if(range === "thisYear") return d.getFullYear() === y;
    return true;
  }

  function calc(){
    const list = entries.filter(e => withinRange(e.date));
    let sumIn = 0, sumOut = 0;
    for(const e of list){
      if(e.type === "out") sumOut += Math.abs(e.amount);
      else sumIn += Math.abs(e.amount);
    }
    return { sumIn, sumOut, bal: sumIn - sumOut, count: list.length, list };
  }

  function render(){
    if(!el.date.value) el.date.value = todayISO();
    el.unitPrice.value = String(unitPrice);

    const { sumIn, sumOut, bal, count, list } = calc();
    el.kpiIn.textContent = fmtYen(sumIn);
    el.kpiOut.textContent = fmtYen(sumOut);
    el.kpiBal.textContent = fmtYen(bal);
    el.kpiCnt.textContent = String(count);

    el.list.innerHTML = "";
    if(list.length === 0){
      const li = document.createElement("li");
      li.className = "item";
      li.innerHTML = `<div class="main"><div class="desc">ã¾ã è¨˜éŒ²ãŒãªã„ã‚ˆ</div><div class="meta">ä¸Šã®ã€Œè¿½åŠ ã€ã‹ã‚‰å…¥ã‚Œã¦ã­</div></div>`;
      el.list.appendChild(li);
      return;
    }

    const sorted = [...list].sort((a,b) => (a.date === b.date ? (a.id > b.id ? -1 : 1) : (a.date > b.date ? -1 : 1)));
    for(const e of sorted){
      const li = document.createElement("li");
      li.className = "item";

      const typeLabel = e.type === "chore" ? "ğŸ§¹ ãŠæ‰‹ä¼ã„" : e.type === "in" ? "ğŸ’° åå…¥" : "ğŸ›’ æ”¯å‡º";
      const badgeClass = e.type === "chore" ? "chore" : e.type === "in" ? "in" : "out";
      const amt = Math.abs(Math.trunc(num(e.amount)));
      const isOut = (e.type === "out");
      const amtTxt = (isOut ? "-" : "+") + fmtYen(amt);
      const amtClass = isOut ? "minus" : "plus";
      const desc = (e.desc || "").trim() || (e.type === "out" ? "ï¼ˆæ”¯å‡ºï¼‰" : e.type === "in" ? "ï¼ˆåå…¥ï¼‰" : "ï¼ˆãŠæ‰‹ä¼ã„ï¼‰");

      li.innerHTML = `
        <div class="main">
          <div class="head">
            <span class="badgeType ${badgeClass}">${typeLabel}</span>
            <span class="amt ${amtClass}">${amtTxt}</span>
          </div>
          <div class="desc">${escapeHtml(desc)}</div>
          <div class="meta">æ—¥ä»˜ï¼š${new Date(e.date).toLocaleDateString()}</div>
        </div>
        <div class="actions">
          <button class="pill" data-del="1" title="å‰Šé™¤">ğŸ—‘</button>
        </div>
      `;

      li.querySelector('[data-del="1"]').addEventListener("click", async () => {
        entries = entries.filter(x => x.id !== e.id);
        render(); // ç”»é¢ã¯å³
        saving = true;
        setHint("â¬†ï¸ åŒæœŸï¼šä¿å­˜ä¸­â€¦");
        const r = await remoteSet(KEY, entries);
        saving = false;
        if(!r || !r.ok) toast("å…±æœ‰ä¿å­˜ã«å¤±æ•—ï¼š" + (r?.error || "unknown"));
        else toast("å‰Šé™¤ã—ãŸã‚ˆï¼ˆå…±æœ‰OKï¼‰");
        lastSigEntries = sigOf(entries);
        setHint("âœ… åŒæœŸï¼šOK");
      });

      el.list.appendChild(li);
    }
  }

  async function syncOnce(label=false){
    if(saving) return;

    try{
      if(label) setHint("â¬‡ï¸ åŒæœŸï¼šèª­ã¿è¾¼ã¿ä¸­â€¦");
      const remoteEntries = await remoteGet(KEY);
      const remoteUnit = await remoteGet(KEY_UNIT);

      if(Array.isArray(remoteEntries)){
        const sigE = sigOf(remoteEntries);
        if(sigE !== lastSigEntries){
          entries = remoteEntries;
          lastSigEntries = sigE;
          render();
        }
      }
      if(typeof remoteUnit === "number"){
        const sigU = String(remoteUnit);
        if(sigU !== lastSigUnit){
          unitPrice = Math.max(0, Math.trunc(remoteUnit));
          lastSigUnit = sigU;
          if(mode === "chore") el.amount.value = String(unitPrice);
          render();
        }
      }

      setHint("âœ… åŒæœŸï¼šOK");
      if(label) toast("å…±æœ‰ã‚’æ›´æ–°ã—ãŸã‚ˆ");
    }catch{
      setHint("âš ï¸ åŒæœŸï¼šé€šä¿¡ã‚¨ãƒ©ãƒ¼");
    }
  }

  async function addEntry(){
    const date = el.date.value || todayISO();
    const desc = String(el.desc.value || "").trim().slice(0,40);

    if(mode === "chore"){
      const amount = Math.max(0, Math.trunc(num(unitPrice)));
      entries.push({ id: makeId(), date, type:"chore", desc: desc || "ï¼ˆãŠæ‰‹ä¼ã„ï¼‰", amount });
    }else if(mode === "in"){
      const amount = Math.max(0, Math.trunc(num(el.amount.value)));
      if(!amount){ toast("é‡‘é¡ã‚’å…¥ã‚Œã¦ã­"); el.amount.focus(); return; }
      entries.push({ id: makeId(), date, type:"in", desc: desc || "ï¼ˆåå…¥ï¼‰", amount });
    }else{
      const amount = Math.max(0, Math.trunc(num(el.amount.value)));
      if(!amount){ toast("é‡‘é¡ã‚’å…¥ã‚Œã¦ã­"); el.amount.focus(); return; }
      entries.push({ id: makeId(), date, type:"out", desc: desc || "ï¼ˆæ”¯å‡ºï¼‰", amount });
    }

    // ç”»é¢ã¯å³åæ˜ 
    render();

    // è£ã§ä¿å­˜
    saving = true;
    setHint("â¬†ï¸ åŒæœŸï¼šä¿å­˜ä¸­â€¦");
    const r = await remoteSet(KEY, entries);
    saving = false;

    if(!r || !r.ok){
      toast("å…±æœ‰ä¿å­˜ã«å¤±æ•—ï¼š" + (r?.error || "unknown"));
      setHint("âš ï¸ åŒæœŸï¼šå¤±æ•—");
    }else{
      toast("è¿½åŠ ã—ãŸã‚ˆï¼ï¼ˆå…±æœ‰OKï¼‰");
      setHint("âœ… åŒæœŸï¼šOK");
      lastSigEntries = sigOf(entries);
    }

    el.desc.value = "";
    el.amount.value = (mode === "chore") ? String(unitPrice) : "";
    el.desc.focus();
  }

  // events
  el.tabChore.addEventListener("click", () => setMode("chore"));
  el.tabIncome.addEventListener("click", () => setMode("in"));
  el.tabExpense.addEventListener("click", () => setMode("out"));

  el.addBtn.addEventListener("click", addEntry);
  el.clearBtn.addEventListener("click", () => { el.desc.value=""; el.amount.value=(mode==="chore")?String(unitPrice):""; toast("å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢ã—ãŸã‚ˆ"); });

  el.wipeBtn.addEventListener("click", async () => {
    if(!confirm("å…¨éƒ¨æ¶ˆã—ã¾ã™ã€‚ã»ã‚“ã¨ã†ã«OKï¼Ÿ")) return;
    entries = [];
    render();
    saving = true;
    setHint("â¬†ï¸ åŒæœŸï¼šä¿å­˜ä¸­â€¦");
    const r = await remoteSet(KEY, entries);
    saving = false;
    toast(r && r.ok ? "å…¨éƒ¨æ¶ˆã—ãŸã‚ˆï¼ˆå…±æœ‰OKï¼‰" : "å…±æœ‰ä¿å­˜ã«å¤±æ•—ï¼š" + (r?.error || "unknown"));
    lastSigEntries = sigOf(entries);
    setHint(r && r.ok ? "âœ… åŒæœŸï¼šOK" : "âš ï¸ åŒæœŸï¼šå¤±æ•—");
  });

  el.syncBtn.addEventListener("click", () => syncOnce(true));
  el.rangeSel.addEventListener("change", () => { range = el.rangeSel.value; render(); });

  el.unitPrice.addEventListener("change", async () => {
    unitPrice = Math.max(0, Math.trunc(num(el.unitPrice.value)));
    if(mode === "chore") el.amount.value = String(unitPrice);
    render();

    saving = true;
    setHint("â¬†ï¸ åŒæœŸï¼šä¿å­˜ä¸­â€¦");
    const r = await remoteSet(KEY_UNIT, unitPrice);
    saving = false;

    toast(r && r.ok ? "1å›ã®é‡‘é¡ã‚’ä¿å­˜ï¼ˆå…±æœ‰OKï¼‰" : "å…±æœ‰ä¿å­˜ã«å¤±æ•—ï¼š" + (r?.error || "unknown"));
    lastSigUnit = String(unitPrice);
    setHint(r && r.ok ? "âœ… åŒæœŸï¼šOK" : "âš ï¸ åŒæœŸï¼šå¤±æ•—");
  });

  // init
  (async () => {
    el.date.value = todayISO();
    setMode("chore");
    render();

    setHint("â¬‡ï¸ åŒæœŸï¼šåˆå›èª­ã¿è¾¼ã¿â€¦");
    await syncOnce(true);

    // â˜…è‡ªå‹•ãƒãƒ¼ãƒªãƒ³ã‚°ï¼ˆ2ç§’ï¼‰
    setInterval(() => syncOnce(false), 2000);
  })();
})();
</script>
</body>
</html>
