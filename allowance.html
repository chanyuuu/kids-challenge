<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ãŠå°é£ã„è¨˜éŒ²å¸³</title>
  <style>
    :root{
      --bg:#f7f7ff;
      --card:#ffffff;
      --ink:#1f2330;
      --muted: rgba(31,35,48,.65);
      --line: rgba(0,0,0,.10);
      --shadow: 0 10px 22px rgba(0,0,0,.10);
      --radius: 18px;

      --good:#22c55e;
      --bad:#ff5a7a;
      --blue:#3aa0ff;
      --purple:#8b5cf6;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
      color: var(--ink);
      background:
        radial-gradient(circle at 20% 5%, rgba(58,160,255,.18), transparent 40%),
        radial-gradient(circle at 90% 15%, rgba(139,92,246,.16), transparent 45%),
        radial-gradient(circle at 40% 95%, rgba(34,197,94,.12), transparent 45%),
        var(--bg);

      min-height: 100vh;
      padding-bottom: calc(20px + env(safe-area-inset-bottom));
    }
    .wrap{ max-width: 620px; margin:0 auto; padding: 16px 14px 40px; }
    .title{
      display:flex; align-items:center; gap:10px; margin: 8px 0 10px;
    }
    .badge{
      width: 46px; height: 46px; border-radius: 14px;
      background: linear-gradient(135deg, var(--blue), var(--purple));
      display:grid; place-items:center;
      box-shadow: var(--shadow);
      flex: 0 0 auto;
      color:#fff;
      font-weight:900;
      font-size: 18px;
    }
    h1{ margin:0; font-size: 22px; line-height:1.2; }
    .sub{ margin:2px 0 0; font-size:12px; color: var(--muted); }

    .grid{ display:grid; gap: 12px; }
    .card{
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      border: 2px solid rgba(255,255,255,.6);
    }

    .stats{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .stat{
      padding: 12px;
      border-radius: 16px;
      border: 2px solid var(--line);
      background: rgba(0,0,0,.02);
    }
    .stat .k{ font-size:12px; color: var(--muted); font-weight:800; }
    .stat .v{ font-size: 20px; font-weight: 950; margin-top: 4px; }
    .v.good{ color: var(--good); }
    .v.bad{ color: var(--bad); }

    .row{ display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
    label{ font-size: 12px; color: var(--muted); font-weight: 800; display:block; margin: 0 0 6px; }

    /* iPhone Safariã®å…¥åŠ›ã‚ºãƒ¼ãƒ å¯¾ç­–ï¼š16pxä»¥ä¸Š */
    input[type="text"], input[type="number"], input[type="date"], select{
      width: 100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 2px solid rgba(0,0,0,.12);
      outline:none;
      font-size: 16px;
      background: rgba(255,255,255,.96);
    }
    input:focus, select:focus{
      border-color: rgba(58,160,255,.65);
      box-shadow: 0 0 0 4px rgba(58,160,255,.18);
    }

    .col{ flex:1 1 160px; min-width: 140px; }
    .col.small{ flex: 0 0 120px; min-width: 120px; }

    .btn{
      border:none;
      border-radius: 14px;
      padding: 12px 12px;
      font-weight: 950;
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
      white-space: nowrap;
    }
    .btnPrimary{
      background: linear-gradient(135deg, var(--blue), var(--purple));
      color:#fff;
      box-shadow: 0 10px 20px rgba(0,0,0,.14);
    }
    .btnGhost{
      background: rgba(0,0,0,.05);
      border: 2px solid rgba(0,0,0,.10);
      color: var(--ink);
      box-shadow: none;
    }
    .btnDanger{
      background: rgba(255,90,122,.12);
      border: 2px solid rgba(255,90,122,.35);
      color: var(--ink);
      box-shadow:none;
      font-weight: 900;
    }
    .btn:active{ transform: translateY(1px); }

    .seg{
      display:flex; gap: 8px; flex-wrap: wrap;
      padding: 10px;
      border-radius: 16px;
      background: rgba(0,0,0,.03);
      border: 2px solid rgba(0,0,0,.06);
    }
    .seg button{
      flex: 1 1 140px;
      border-radius: 14px;
      border: 2px solid rgba(0,0,0,.10);
      background: #fff;
      padding: 10px 12px;
      font-weight: 950;
      cursor:pointer;
    }
    .seg button.active{
      border-color: rgba(58,160,255,.55);
      box-shadow: 0 0 0 4px rgba(58,160,255,.14);
    }

    .hint{ font-size: 12px; color: var(--muted); line-height: 1.4; margin-top: 8px; }

    .list{
      list-style:none;
      padding:0;
      margin:0;
      display:grid;
      gap: 10px;
    }
    .item{
      display:flex;
      gap: 10px;
      align-items:flex-start;
      padding: 12px;
      border-radius: 16px;
      border: 2px solid rgba(0,0,0,.06);
      background: rgba(0,0,0,.02);
    }
    .pill{
      font-size: 12px;
      font-weight: 950;
      border-radius: 999px;
      padding: 7px 10px;
      border: 2px solid rgba(0,0,0,.10);
      background:#fff;
      white-space: nowrap;
    }
    .pill.in{ background: rgba(34,197,94,.12); border-color: rgba(34,197,94,.35); }
    .pill.out{ background: rgba(255,90,122,.12); border-color: rgba(255,90,122,.35); }
    .main{
      flex: 1;
      min-width: 0;
    }
    .line1{
      display:flex; gap: 8px; flex-wrap: wrap; align-items: baseline;
    }
    .desc{ font-weight: 950; }
    .meta{ font-size: 12px; color: var(--muted); font-weight: 800; }
    .amt{
      font-weight: 1000;
      font-size: 16px;
      margin-top: 6px;
    }
    .amt.in{ color: var(--good); }
    .amt.out{ color: var(--bad); }

    .actions{ display:flex; gap: 8px; align-items:center; flex: 0 0 auto; }
    .mini{
      border-radius: 12px;
      padding: 10px 10px;
      border: 2px solid rgba(0,0,0,.10);
      background:#fff;
      cursor:pointer;
      font-weight: 950;
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: calc(18px + env(safe-area-inset-bottom));
      transform: translateX(-50%);
      background: rgba(0,0,0,.85);
      color:#fff;
      padding: 10px 12px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 13px;
      opacity: 0;
      pointer-events:none;
      transition: opacity .2s ease, transform .2s ease;
      z-index: 999;
    }
    .toast.show{ opacity:1; transform: translateX(-50%) translateY(-2px); }

    .twoCols{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    @media (min-width: 520px){
      .twoCols{ grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">
      <div class="badge">Â¥</div>
      <div>
        <h1>ãŠå°é£ã„è¨˜éŒ²å¸³</h1>
        <div class="sub">ã‚‚ã‚‰ã£ãŸãƒ»ã¤ã‹ã£ãŸã‚’è¨˜éŒ²ã—ã¦ã€æ®‹é«˜ãŒã‚ã‹ã‚‹</div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <div style="font-weight:950;">é›†è¨ˆ</div>
          <div class="row" style="gap:8px;">
            <div class="col small">
              <label>è¡¨ç¤º</label>
              <select id="rangeSel">
                <option value="month">ä»Šæœˆ</option>
                <option value="all">å…¨æœŸé–“</option>
              </select>
            </div>
          </div>
        </div>

        <div class="stats" style="margin-top:10px;">
          <div class="stat">
            <div class="k">ã‚‚ã‚‰ã£ãŸï¼ˆé¸æŠæœŸé–“ï¼‰</div>
            <div class="v good" id="sumIn">Â¥0</div>
          </div>
          <div class="stat">
            <div class="k">ã¤ã‹ã£ãŸï¼ˆé¸æŠæœŸé–“ï¼‰</div>
            <div class="v bad" id="sumOut">Â¥0</div>
          </div>
          <div class="stat">
            <div class="k">ã®ã“ã‚Šï¼ˆé¸æŠæœŸé–“ï¼‰</div>
            <div class="v" id="balanceRange">Â¥0</div>
          </div>
          <div class="stat">
            <div class="k">ãœã‚“ã¶ã® ã®ã“ã‚Šï¼ˆå…¨æœŸé–“ï¼‰</div>
            <div class="v" id="balanceAll">Â¥0</div>
          </div>
        </div>

        <div class="hint">
          â€» 2å°ï¼ˆæœ€å¤§3å°ï¼‰ã§å…±æœ‰ã—ã¾ã™ï¼ˆé€šä¿¡ãŒã‚ã‚‹ç’°å¢ƒã§ï¼‰<br>
          â€» ã€Œä»Šæœˆã€ã¯ç«¯æœ«ã®æ—¥ä»˜ã§è‡ªå‹•åˆ¤å®šã—ã¾ã™
        </div>
      </div>

      <div class="card">
        <div class="seg" role="tablist" aria-label="å…¥åŠ›ã‚¿ã‚¤ãƒ—">
          <button id="tabChore" class="active" type="button">ğŸ§¹ ãŠæ‰‹ä¼ã„ï¼ˆ50å††Ã—å›æ•°ï¼‰</button>
          <button id="tabIncome" type="button">â• ã‚‚ã‚‰ã£ãŸï¼ˆè‡ªç”±å…¥åŠ›ï¼‰</button>
          <button id="tabExpense" type="button">â– ã¤ã‹ã£ãŸï¼ˆè‡ªç”±å…¥åŠ›ï¼‰</button>
        </div>

        <div style="margin-top:12px;" class="twoCols">
          <div>
            <label>æ—¥ä»˜ï¼ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã§ãˆã‚‰ã¹ã‚‹ï¼‰</label>
            <input id="date" type="date" />
          </div>
          <div>
            <label>å†…å®¹</label>
            <input id="desc" type="text" maxlength="30" placeholder="ä¾‹ï¼šçš¿æ´—ã„ã€ã‚²ãƒ¼ãƒ ã€é§„è“å­" />
          </div>
          <div id="countBox">
            <label>å›æ•°ï¼ˆãŠæ‰‹ä¼ã„ï¼‰</label>
            <input id="count" type="number" min="1" step="1" inputmode="numeric" value="1" />
          </div>
          <div id="amountBox" style="display:none;">
            <label>é‡‘é¡ï¼ˆå††ï¼‰</label>
            <input id="amount" type="number" min="0" step="10" inputmode="numeric" placeholder="ä¾‹ï¼š200" />
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <button class="btn btnPrimary" id="addBtn" type="button" style="flex:1;">ï¼‹ è¿½åŠ </button>
          <button class="btn btnGhost" id="clearBtn" type="button">å…¥åŠ›ã‚¯ãƒªã‚¢</button>
        </div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <div style="font-weight:950;">å±¥æ­´</div>
          <div class="row" style="gap:8px;">
            <button class="btn btnDanger" id="wipeBtn" type="button">å…¨æ¶ˆå»</button>
          </div>
        </div>

        <ul class="list" id="list" style="margin-top:12px;"></ul>
        <div class="hint">â€» é–“é•ãˆãŸã‚‰ã‚´ãƒŸç®±ã§å‰Šé™¤ã§ãã¾ã™</div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">ä¿å­˜ã—ãŸã‚ˆï¼</div>

<script>
(() => {
  // ===== å›ºå®šè¨­å®šï¼ˆè¦æœ›ï¼‰=====
  const CHORE_UNIT_PRICE = 50; // ãŠæ‰‹ä¼ã„ã¯å›ºå®š50å††

  // ===== å…±æœ‰ã‚­ãƒ¼ï¼ˆGASãƒ»ç«¯æœ«å†…ã§å…±é€šï¼‰=====
  const KEY = "allowance_book_v1_shared"; // â€»å…±æœ‰ç”¨ã«æ˜ç¤ºï¼ˆè¡çªã‚’é¿ã‘ã‚‹ãŸã‚ï¼‰

  // ===== GASï¼ˆtodoã¨åŒã˜ï¼‰=====
  const API_URL = "https://script.google.com/macros/s/AKfycbxVT20cF2cEQwbXWEn4_MlvKBDAq9YTW6mcewmPz8imWyrR39MnuqdPxQ9ZXO9Q91JG/exec";
  const API_TOKEN = "kids-2026-0130-asahi-0620";

  async function apiPost(payload){
    try{
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({ token: API_TOKEN, ...payload })
      });
      return await res.json();
    }catch(err){
      return { ok:false, error: String(err?.message || err) };
    }
  }

  async function remoteSet(key, value){
    try{ await apiPost({ mode:"save", key, data:value }); }catch{}
  }

  async function remoteGet(key){
    try{
      const url = `${API_URL}?mode=load&token=${encodeURIComponent(API_TOKEN)}&key=${encodeURIComponent(key)}&_=${Date.now()}`;
      const res = await fetch(url, { cache:"no-store" });
      const j = await res.json();
      return (j && j.ok) ? j.data : null;
    }catch{
      return null;
    }
  }

  async function remotePing(){
    try{
      const url = `${API_URL}?mode=ping&token=${encodeURIComponent(API_TOKEN)}&_=${Date.now()}`;
      const res = await fetch(url, { cache:"no-store" });
      return !!res.ok;
    }catch{
      return false;
    }
  }

  // ===== ç«¯æœ«å†…ä¿å­˜ï¼ˆè¡¨ç¤ºã‚’å³å‡ºã™ãŸã‚ï¼‰=====
  function canUseStorage(){
    try{
      const k = "__t__" + Date.now();
      localStorage.setItem(k, "1");
      localStorage.removeItem(k);
      return true;
    }catch{ return false; }
  }
  const STORAGE_OK = canUseStorage();
  const mem = {};

  function loadJson(key){
    try{
      const raw = STORAGE_OK ? localStorage.getItem(key) : mem[key];
      if(!raw) return null;
      return JSON.parse(raw);
    }catch{ return null; }
  }
  function storeLocal(key, value){
    const raw = JSON.stringify(value);
    try{
      if(STORAGE_OK) localStorage.setItem(key, raw);
      else mem[key] = raw;
    }catch{}
  }
  function saveJson(key, value){
    storeLocal(key, value);
    remoteSet(key, value); // â˜…å…±æœ‰ã¸ä¿å­˜
  }

  // ===== utils =====
  function makeId(){
    return "id-" + Math.random().toString(16).slice(2) + "-" + Date.now().toString(16);
  }
  function todayISO(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  }
  function monthKey(iso){
    return String(iso).slice(0,7);
  }
  function yen(n){
    const v = Number.isFinite(n) ? n : 0;
    return "Â¥" + Math.trunc(v).toLocaleString("ja-JP");
  }
  function toast(msg){
    el.toast.textContent = msg;
    el.toast.classList.add("show");
    clearTimeout(toast._t);
    toast._t = setTimeout(() => el.toast.classList.remove("show"), 900);
  }
  function cleanText(s){
    return String(s ?? "").trim().replace(/\s+/g," ").slice(0,30);
  }
  function num(v){
    const n = Number(v);
    return Number.isFinite(n) ? n : 0;
  }
  function safeStringify(x){
    try{ return JSON.stringify(x); }catch{ return ""; }
  }
  function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

  // ===== state =====
  /** @type {{id:string, date:string, type:"in"|"out", desc:string, amount:number}[]} */
  let entries = loadJson(KEY);
  if(!Array.isArray(entries)) entries = [];

  let mode = "chore"; // "chore" | "income" | "expense"
  let range = "month"; // "month" | "all"

  // ===== elements =====
  const el = {
    rangeSel: document.getElementById("rangeSel"),
    sumIn: document.getElementById("sumIn"),
    sumOut: document.getElementById("sumOut"),
    balanceRange: document.getElementById("balanceRange"),
    balanceAll: document.getElementById("balanceAll"),

    tabChore: document.getElementById("tabChore"),
    tabIncome: document.getElementById("tabIncome"),
    tabExpense: document.getElementById("tabExpense"),

    date: document.getElementById("date"),
    desc: document.getElementById("desc"),
    countBox: document.getElementById("countBox"),
    count: document.getElementById("count"),
    amountBox: document.getElementById("amountBox"),
    amount: document.getElementById("amount"),

    addBtn: document.getElementById("addBtn"),
    clearBtn: document.getElementById("clearBtn"),
    wipeBtn: document.getElementById("wipeBtn"),
    list: document.getElementById("list"),
    toast: document.getElementById("toast"),
  };

  // init inputs
  el.date.value = todayISO();

  // ===== rendering =====
  function filtered(){
    if(range === "all") return entries.slice();
    const mk = monthKey(todayISO());
    return entries.filter(e => monthKey(e.date) === mk);
  }

  function sums(list){
    let sin = 0, sout = 0;
    for(const e of list){
      if(e.type === "in") sin += num(e.amount);
      else sout += num(e.amount);
    }
    return { sin, sout, bal: sin - sout };
  }

  function renderStats(){
    const cur = filtered();
    const s1 = sums(cur);
    const sAll = sums(entries);

    el.sumIn.textContent = yen(s1.sin);
    el.sumOut.textContent = yen(s1.sout);
    el.balanceRange.textContent = yen(s1.bal);
    el.balanceRange.className = "v " + (s1.bal >= 0 ? "good" : "bad");

    el.balanceAll.textContent = yen(sAll.bal);
    el.balanceAll.className = "v " + (sAll.bal >= 0 ? "good" : "bad");

    // ãŠæ‰‹ä¼ã„ã‚¿ãƒ–ã¯å›ºå®šè¡¨ç¤º
    el.tabChore.textContent = `ğŸ§¹ ãŠæ‰‹ä¼ã„ï¼ˆ${CHORE_UNIT_PRICE}å††Ã—å›æ•°ï¼‰`;
  }

  function renderList(){
    const list = filtered()
      .slice()
      .sort((a,b) => (b.date.localeCompare(a.date)) || (b.id.localeCompare(a.id)));

    el.list.innerHTML = "";

    if(list.length === 0){
      const li = document.createElement("li");
      li.className = "item";
      li.innerHTML = `<div class="main">
        <div class="desc">ã¾ã è¨˜éŒ²ãŒãªã„ã‚ˆ</div>
        <div class="meta">ä¸Šã®ã€Œï¼‹ è¿½åŠ ã€ã‹ã‚‰å…¥ã‚Œã¦ã­</div>
      </div>`;
      el.list.appendChild(li);
      return;
    }

    for(const e of list){
      const li = document.createElement("li");
      li.className = "item";

      const pill = document.createElement("span");
      pill.className = "pill " + (e.type === "in" ? "in" : "out");
      pill.textContent = (e.type === "in") ? "ã‚‚ã‚‰ã£ãŸ" : "ã¤ã‹ã£ãŸ";

      const main = document.createElement("div");
      main.className = "main";

      const line1 = document.createElement("div");
      line1.className = "line1";

      const desc = document.createElement("span");
      desc.className = "desc";
      desc.textContent = e.desc || (e.type === "in" ? "ï¼ˆã‚‚ã‚‰ã£ãŸï¼‰" : "ï¼ˆã¤ã‹ã£ãŸï¼‰");

      const meta = document.createElement("span");
      meta.className = "meta";
      meta.textContent = e.date;

      line1.appendChild(desc);
      line1.appendChild(meta);

      const amt = document.createElement("div");
      amt.className = "amt " + (e.type === "in" ? "in" : "out");
      amt.textContent = (e.type === "in" ? "+" : "-") + yen(num(e.amount)).slice(1);

      main.appendChild(line1);
      main.appendChild(amt);

      const actions = document.createElement("div");
      actions.className = "actions";

      const del = document.createElement("button");
      del.className = "mini";
      del.textContent = "ğŸ—‘ï¸";
      del.title = "å‰Šé™¤";
      del.addEventListener("click", () => {
        entries = entries.filter(x => x.id !== e.id);
        saveJson(KEY, entries);
        toast("å‰Šé™¤ã—ãŸã‚ˆ");
        render();
      });

      actions.appendChild(del);

      li.appendChild(pill);
      li.appendChild(main);
      li.appendChild(actions);
      el.list.appendChild(li);
    }
  }

  function renderMode(){
    el.tabChore.classList.toggle("active", mode === "chore");
    el.tabIncome.classList.toggle("active", mode === "income");
    el.tabExpense.classList.toggle("active", mode === "expense");

    if(mode === "chore"){
      el.countBox.style.display = "";
      el.amountBox.style.display = "none";
      el.amount.value = "";
      el.count.value = el.count.value || "1";
    }else{
      el.countBox.style.display = "none";
      el.amountBox.style.display = "";
      el.count.value = "1";
    }
  }

  function render(){
    renderMode();
    renderStats();
    renderList();
  }

  // ===== actions =====
  function setMode(next){
    mode = next;
    renderMode();
  }

  function addEntry(){
    const date = el.date.value || todayISO();
    const desc = cleanText(el.desc.value);

    if(mode === "chore"){
      const c = Math.max(1, Math.trunc(num(el.count.value)));
      const amount = CHORE_UNIT_PRICE * c;
      entries.push({ id: makeId(), date, type:"in", desc: desc || `ãŠæ‰‹ä¼ã„Ã—${c}`, amount });
    } else if(mode === "income") {
      const amount = Math.max(0, Math.trunc(num(el.amount.value)));
      if(amount === 0){ toast("é‡‘é¡ã‚’å…¥ã‚Œã¦ã­"); el.amount.focus(); return; }
      entries.push({ id: makeId(), date, type:"in", desc: desc || "ï¼ˆã‚‚ã‚‰ã£ãŸï¼‰", amount });
    } else {
      const amount = Math.max(0, Math.trunc(num(el.amount.value)));
      if(amount === 0){ toast("é‡‘é¡ã‚’å…¥ã‚Œã¦ã­"); el.amount.focus(); return; }
      entries.push({ id: makeId(), date, type:"out", desc: desc || "ï¼ˆã¤ã‹ã£ãŸï¼‰", amount });
    }

    saveJson(KEY, entries);
    toast("è¿½åŠ ã—ãŸã‚ˆï¼");

    el.desc.value = "";
    el.amount.value = "";
    el.count.value = "1";

    render();
  }

  function clearInputs(){
    el.desc.value = "";
    el.amount.value = "";
    el.count.value = "1";
    el.date.value = todayISO();
    toast("å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢ã—ãŸã‚ˆ");
  }

  function wipeAll(){
    const ok = confirm("å…¨éƒ¨æ¶ˆã—ã¾ã™ã€‚ã»ã‚“ã¨ã†ã«OKï¼Ÿ");
    if(!ok) return;
    entries = [];
    saveJson(KEY, entries);
    toast("å…¨éƒ¨æ¶ˆã—ãŸã‚ˆ");
    render();
  }

  // ===== events =====
  el.tabChore.addEventListener("click", () => setMode("chore"));
  el.tabIncome.addEventListener("click", () => setMode("income"));
  el.tabExpense.addEventListener("click", () => setMode("expense"));

  el.addBtn.addEventListener("click", addEntry);
  el.clearBtn.addEventListener("click", clearInputs);
  el.wipeBtn.addEventListener("click", wipeAll);

  el.rangeSel.addEventListener("change", () => {
    range = el.rangeSel.value;
    render();
  });

  // ===== init render (ã¾ãšãƒ­ãƒ¼ã‚«ãƒ«ã§å³è¡¨ç¤º) =====
  render();

  // ===== å…±æœ‰åŒæœŸï¼šæ¸©ã‚ping + 2ç§’ãƒãƒ¼ãƒªãƒ³ã‚° =====
  const SYNC = {
    lastStr: safeStringify(entries),
    fail: 0,
    pollTimer: null,
    keepAliveTimer: null,
  };

  function applyRemote(remoteEntries){
    if(!Array.isArray(remoteEntries)) return;
    const s = safeStringify(remoteEntries);
    if(!s || s === SYNC.lastStr) return;

    SYNC.lastStr = s;
    entries = remoteEntries;
    storeLocal(KEY, entries); // ãƒ­ãƒ¼ã‚«ãƒ«ã«ã‚‚åæ˜ ï¼ˆã‚¨ã‚³ãƒ¼ä¿å­˜ã¯ã—ãªã„ï¼‰
    render();
  }

  // keep warm pingï¼ˆè¡¨ç¤ºä¸­3åˆ† / éè¡¨ç¤º10åˆ†ï¼‰
  function keepAliveInterval(){
    return document.hidden ? 10 * 60 * 1000 : 3 * 60 * 1000;
  }
  function scheduleKeepAlive(){
    clearTimeout(SYNC.keepAliveTimer);
    SYNC.keepAliveTimer = setTimeout(async () => {
      await remotePing();
      scheduleKeepAlive();
    }, keepAliveInterval());
  }

  function basePollInterval(){
    return document.hidden ? 20000 : 2000;
  }
  function backoff(ms){
    if(SYNC.fail >= 4) return Math.max(ms, 10000);
    if(SYNC.fail >= 2) return Math.max(ms, 5000);
    return ms;
  }

  async function pollOnce(){
    const re = await remoteGet(KEY);
    if(re !== null){
      SYNC.fail = 0;
      applyRemote(re);
    }else{
      SYNC.fail = Math.min(SYNC.fail + 1, 6);
    }
  }

  async function tick(){
    await pollOnce();
    const ms = backoff(basePollInterval());
    clearTimeout(SYNC.pollTimer);
    SYNC.pollTimer = setTimeout(tick, ms);
  }

  async function warmUpThenInitialLoad(){
    // èµ·å‹•ç›´å¾Œï¼špingãŒè¿”ã‚‹ã¾ã§è»½ãè©¦ã™ï¼ˆæœ€å¤§3å›ï¼‰
    for(let i=0;i<3;i++){
      const ok = await remotePing();
      if(ok) break;
      await sleep(400);
    }
    await pollOnce();
  }

  document.addEventListener("visibilitychange", () => {
    scheduleKeepAlive();
    clearTimeout(SYNC.pollTimer);
    SYNC.pollTimer = setTimeout(tick, 50);
  });

  scheduleKeepAlive();
  warmUpThenInitialLoad().then(() => tick());

})();
</script>
</body>
</html>
