<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ãŠå°é£ã„è¨˜éŒ²å¸³</title>
  <style>
    :root{
      --bg:#f7f7ff;
      --card:#ffffff;
      --ink:#1f2330;
      --muted: rgba(31,35,48,.65);
      --line: rgba(0,0,0,.10);
      --shadow: 0 10px 22px rgba(0,0,0,.10);
      --radius: 18px;

      --good:#22c55e;
      --bad:#ff5a7a;
      --blue:#3aa0ff;
      --purple:#8b5cf6;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
      background:
        radial-gradient(circle at 15% 10%, rgba(58,160,255,.20), transparent 40%),
        radial-gradient(circle at 90% 20%, rgba(139,92,246,.18), transparent 45%),
        radial-gradient(circle at 40% 95%, rgba(34,197,94,.12), transparent 45%),
        var(--bg);
      color:var(--ink);
      padding-bottom: 88px;
    }
    .wrap{ max-width:560px; margin:0 auto; padding:16px 14px 40px; }
    .title{ display:flex; align-items:center; gap:10px; margin:8px 0 10px; }
    .badge{
      width:46px; height:46px; border-radius:14px;
      background:linear-gradient(135deg,var(--blue),var(--purple));
      display:grid; place-items:center;
      box-shadow:var(--shadow);
    }
    .badge span{ font-size:22px; filter:drop-shadow(0 2px 0 rgba(0,0,0,.12)); }
    h1{ margin:0; font-size:22px; line-height:1.2; }
    .sub{ margin:2px 0 0; font-size:12px; color:var(--muted); }
    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
      border:2px solid rgba(255,255,255,.65);
    }
    .stack{ display:grid; gap:12px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; }
    .field{ flex:1 1 140px; }
    label{ display:block; font-size:12px; color:var(--muted); margin:0 0 6px 2px; }
    input[type="text"], input[type="number"], select{
      width:100%;
      padding:12px;
      border-radius:14px;
      border:2px solid rgba(0,0,0,.12);
      outline:none;
      font-size:15px;
      background:rgba(255,255,255,.92);
    }
    input:focus, select:focus{
      border-color:rgba(58,160,255,.65);
      box-shadow:0 0 0 4px rgba(58,160,255,.18);
    }
    .btn{
      border:none;
      border-radius:14px;
      padding:12px 14px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
      touch-action:manipulation;
      box-shadow:0 8px 18px rgba(0,0,0,.12);
    }
    .btnPrimary{ background:linear-gradient(135deg,var(--blue),var(--purple)); color:#fff; }
    .btnGhost{ background:rgba(0,0,0,.06); box-shadow:none; border:2px solid rgba(0,0,0,.10); color:var(--ink); }
    .btnDanger{ background:rgba(255,90,122,.12); box-shadow:none; border:2px solid rgba(255,90,122,.35); color:var(--ink); }
    .btn:active{ transform:translateY(1px); }

    .tabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin:0 0 12px;
    }
    .tab{
      padding:10px 12px;
      border-radius:999px;
      border:2px solid rgba(0,0,0,.10);
      background:#fff;
      font-weight:900;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      border-color:rgba(58,160,255,.35);
      background:rgba(58,160,255,.10);
    }

    .summary{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    .pill{
      border-radius:16px;
      padding:12px;
      border:2px solid rgba(0,0,0,.08);
      background:rgba(0,0,0,.02);
    }
    .pill .k{ font-size:12px; color:var(--muted); }
    .pill .v{ font-size:18px; font-weight:950; margin-top:4px; }
    .good{ color:var(--good); }
    .bad{ color:var(--bad); }

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius:16px;
      border:2px solid rgba(0,0,0,.08);
      background:#fff;
    }
    thead th{
      text-align:left;
      font-size:12px;
      color:var(--muted);
      padding:10px 10px;
      background:rgba(0,0,0,.03);
      border-bottom:1px solid rgba(0,0,0,.06);
    }
    tbody td{
      padding:12px 10px;
      border-bottom:1px solid rgba(0,0,0,.06);
      font-weight:800;
      vertical-align:top;
    }
    tbody tr:last-child td{ border-bottom:none; }
    .tmuted{ color:var(--muted); font-weight:700; }
    .right{ text-align:right; }
    .mini{
      font-size:12px;
      color:var(--muted);
      margin-top:6px;
      line-height:1.35;
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background:rgba(0,0,0,.85);
      color:#fff;
      padding:10px 12px;
      border-radius:999px;
      font-weight:900;
      font-size:13px;
      opacity:0;
      pointer-events:none;
      transition:opacity .2s ease, transform .2s ease;
      z-index:999;
    }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(-2px); }

    .backBar{
      position:fixed;
      left:0; right:0; bottom:0;
      padding: 12px 12px calc(12px + env(safe-area-inset-bottom));
      background: rgba(255,255,255,.88);
      backdrop-filter: blur(10px);
      border-top: 2px solid rgba(0,0,0,.08);
      z-index: 998;
    }
    .backBtn{
      display:block;
      max-width:560px;
      margin:0 auto;
      text-decoration:none;
      text-align:center;
      padding: 14px 12px;
      border-radius: 16px;
      font-weight: 950;
      color:#fff;
      background: linear-gradient(135deg, var(--blue), var(--purple));
      box-shadow: var(--shadow);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">
      <div class="badge"><span>ğŸ’°</span></div>
      <div>
        <h1>ãŠå°é£ã„è¨˜éŒ²å¸³</h1>
        <div class="sub">ãŠæ‰‹ä¼ã„ãƒ»åå…¥ãƒ»æ”¯å‡ºã‚’è¨˜éŒ²ã—ã¦ã€åˆè¨ˆã‚’è¦‹ã‚ˆã†</div>
      </div>
    </div>

    <div class="stack">
      <div class="card">
        <div class="tabs">
          <div class="tab active" id="tabChore">ğŸ§¹ ãŠæ‰‹ä¼ã„</div>
          <div class="tab" id="tabIncome">â• åå…¥</div>
          <div class="tab" id="tabExpense">â– æ”¯å‡º</div>
        </div>

        <div class="row">
          <div class="field">
            <label>æ—¥ä»˜</label>
            <input id="date" type="text" />
          </div>
          <div class="field">
            <label id="labelDesc">å†…å®¹ï¼ˆãŠæ‰‹ä¼ã„åï¼‰</label>
            <input id="desc" type="text" maxlength="30" placeholder="ä¾‹ï¼šãŠçš¿æ´—ã„" />
          </div>
          <div class="field" id="fieldCount">
            <label>å›æ•°</label>
            <input id="count" type="number" min="1" step="1" value="1" />
          </div>
          <div class="field" id="fieldAmount" style="display:none;">
            <label>é‡‘é¡ï¼ˆå††ï¼‰</label>
            <input id="amount" type="number" min="0" step="1" placeholder="ä¾‹ï¼š300" />
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <button class="btn btnPrimary" id="addBtn" style="flex:1;">ï¼‹ è¿½åŠ </button>
          <button class="btn btnGhost" id="clearBtn" style="flex:1;">â†©ï¸ å…¥åŠ›ã‚¯ãƒªã‚¢</button>
        </div>

        <div class="row" style="margin-top:10px;">
          <div class="field">
            <label>ãŠæ‰‹ä¼ã„1å›ã®é‡‘é¡ï¼ˆå††ï¼‰</label>
            <input id="unitPrice" type="number" min="0" step="1" />
            <div class="mini">â€»ã€ŒãŠæ‰‹ä¼ã„ã€ã®ã¨ãã ã‘ä½¿ã„ã¾ã™ã€‚å…¥åŠ›ã™ã‚‹ã¨ä¿å­˜ã•ã‚Œã¾ã™ã€‚</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between; align-items:center;">
          <div style="font-weight:950;">é›†è¨ˆ</div>
          <div class="field" style="max-width:170px;">
            <label style="margin:0 0 6px 2px;">è¡¨ç¤ºç¯„å›²</label>
            <select id="range">
              <option value="month">ä»Šæœˆ</option>
              <option value="all">å…¨éƒ¨</option>
            </select>
          </div>
        </div>

        <div class="summary">
          <div class="pill">
            <div class="k">åå…¥ åˆè¨ˆ</div>
            <div class="v good" id="sumIn">0å††</div>
          </div>
          <div class="pill">
            <div class="k">æ”¯å‡º åˆè¨ˆ</div>
            <div class="v bad" id="sumOut">0å††</div>
          </div>
          <div class="pill" style="grid-column:1 / -1;">
            <div class="k">æ®‹ã‚Šï¼ˆåå…¥ - æ”¯å‡ºï¼‰</div>
            <div class="v" id="sumNet">0å††</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between; align-items:center;">
          <div style="font-weight:950;">å±¥æ­´</div>
          <button class="btn btnDanger" id="wipeBtn">ğŸ—‘ï¸ å…¨éƒ¨æ¶ˆã™</button>
        </div>
        <div style="margin-top:10px; overflow:auto;">
          <table>
            <thead>
              <tr>
                <th style="min-width:92px;">æ—¥ä»˜</th>
                <th>å†…å®¹</th>
                <th style="min-width:76px;">åŒºåˆ†</th>
                <th class="right" style="min-width:96px;">é‡‘é¡</th>
                <th style="min-width:68px;"></th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
        <div class="mini" id="hint"></div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">ä¿å­˜ã—ãŸã‚ˆï¼</div>
  <div class="backBar"><a class="backBtn" href="index.html">ğŸ  ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</a></div>

<script>
(() => {
  // ===== safe storage =====
  const KEY = "allowance_book_v1";
  const KEY_UNIT = "allowance_unit_price_v1";

  // ===== shared sync (GAS) =====
  const API_URL = "https://script.google.com/macros/s/AKfycbxVT20cF2cEQwbXWEn4_MlvKBDAq9YTW6mcewmPz8imWyrR39MnuqdPxQ9ZXO9Q91JG/exec";
  const API_TOKEN = "kids-2026-0130-asahi-0620";

  async function apiPost(payload){
    try{
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({ token: API_TOKEN, ...payload })
      });
      return await res.json();
    }catch(err){
      return { ok:false, error: String(err?.message || err) };
    }
  }

  async function remoteSet(key, value){
    // fire and forget (we don't block UI)
    try{ await apiPost({ mode:"save", key, data:value }); }catch{}
  }

  async function remoteGet(key){
    try{
      const url = `${API_URL}?mode=load&token=${encodeURIComponent(API_TOKEN)}&key=${encodeURIComponent(key)}&_=${Date.now()}`;
      const res = await fetch(url, { cache:"no-store" });
      const j = await res.json();
      return (j && j.ok) ? j.data : null;
    }catch{
      return null;
    }
  }

  async function remotePing(){
    try{
      const url = `${API_URL}?mode=ping&token=${encodeURIComponent(API_TOKEN)}&_=${Date.now()}`;
      const res = await fetch(url, { cache:"no-store" });
      return !!res.ok;
    }catch{
      return false;
    }
  }

  function canUseStorage(){
    try{
      const k = "__t__" + Date.now();
      localStorage.setItem(k, "1");
      localStorage.removeItem(k);
      return true;
    }catch{ return false; }
  }
  const STORAGE_OK = canUseStorage();
  const mem = {};

  function loadJson(key){
    try{
      const raw = STORAGE_OK ? localStorage.getItem(key) : mem[key];
      if(!raw) return null;
      return JSON.parse(raw);
    }catch{ return null; }
  }
  function storeLocal(key, value){
    const raw = JSON.stringify(value);
    try{
      if(STORAGE_OK) localStorage.setItem(key, raw);
      else mem[key] = raw;
    }catch{}
  }
  function saveJson(key, value){
    storeLocal(key, value);
    remoteSet(key, value);
  }

  // ===== utils =====
  function makeId(){
    return "id-" + Math.random().toString(16).slice(2) + "-" + Date.now().toString(16);
  }
  function todayISO(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${dd}`;
  }
  function yen(n){
    const x = Math.trunc(n || 0);
    return x.toLocaleString("ja-JP") + "å††";
  }
  function num(v){
    const n = Number(v);
    return Number.isFinite(n) ? n : 0;
  }
  function isSameMonth(iso){
    const d = new Date();
    const ym = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
    return String(iso||"").slice(0,7) === ym;
  }

  // ===== state =====
  /** @type {{id:string, date:string, type:"in"|"out", desc:string, amount:number}[]} */
  let entries = loadJson(KEY);
  if(!Array.isArray(entries)) entries = [];

  // unit price
  let unitPrice = loadJson(KEY_UNIT);
  unitPrice = (typeof unitPrice === "number" && unitPrice >= 0) ? unitPrice : 50;

  let mode = "chore"; // "chore" | "income" | "expense"
  let range = "month"; // "month" | "all"

  // ===== DOM =====
  const el = {
    tabChore: document.getElementById("tabChore"),
    tabIncome: document.getElementById("tabIncome"),
    tabExpense: document.getElementById("tabExpense"),
    date: document.getElementById("date"),
    desc: document.getElementById("desc"),
    count: document.getElementById("count"),
    amount: document.getElementById("amount"),
    fieldCount: document.getElementById("fieldCount"),
    fieldAmount: document.getElementById("fieldAmount"),
    labelDesc: document.getElementById("labelDesc"),
    addBtn: document.getElementById("addBtn"),
    clearBtn: document.getElementById("clearBtn"),
    wipeBtn: document.getElementById("wipeBtn"),
    unitPrice: document.getElementById("unitPrice"),
    tbody: document.getElementById("tbody"),
    sumIn: document.getElementById("sumIn"),
    sumOut: document.getElementById("sumOut"),
    sumNet: document.getElementById("sumNet"),
    rangeSel: document.getElementById("range"),
    hint: document.getElementById("hint"),
    toast: document.getElementById("toast"),
  };

  function toast(msg){
    el.toast.textContent = msg;
    el.toast.classList.add("show");
    clearTimeout(toast._t);
    toast._t = setTimeout(() => el.toast.classList.remove("show"), 950);
  }

  function setMode(next){
    mode = next;
    el.tabChore.classList.toggle("active", mode === "chore");
    el.tabIncome.classList.toggle("active", mode === "income");
    el.tabExpense.classList.toggle("active", mode === "expense");

    if(mode === "chore"){
      el.fieldCount.style.display = "";
      el.fieldAmount.style.display = "none";
      el.labelDesc.textContent = "å†…å®¹ï¼ˆãŠæ‰‹ä¼ã„åï¼‰";
      el.desc.placeholder = "ä¾‹ï¼šãŠçš¿æ´—ã„";
    }else{
      el.fieldCount.style.display = "none";
      el.fieldAmount.style.display = "";
      el.labelDesc.textContent = "å†…å®¹";
      el.desc.placeholder = "ä¾‹ï¼šãŠå¹´ç‰";
    }
    clearInputs();
  }

  function clearInputs(){
    el.date.value = todayISO();
    el.desc.value = "";
    el.count.value = "1";
    el.amount.value = "";
    el.desc.focus();
  }

  function calcAmountForChore(){
    const c = Math.max(1, Math.trunc(num(el.count.value)));
    return c * unitPrice;
  }

  function addEntry(){
    const date = String(el.date.value || "").trim() || todayISO();
    const desc = String(el.desc.value || "").trim().slice(0, 30);
    if(!desc){
      toast("å†…å®¹ã‚’å…¥ã‚Œã¦ã­");
      el.desc.focus();
      return;
    }

    let type = "in";
    let amount = 0;

    if(mode === "chore"){
      type = "in";
      amount = calcAmountForChore();
    }else if(mode === "income"){
      type = "in";
      amount = Math.max(0, Math.trunc(num(el.amount.value)));
    }else{
      type = "out";
      amount = Math.max(0, Math.trunc(num(el.amount.value)));
    }

    const e = { id: makeId(), date, type, desc, amount };
    entries.unshift(e);
    saveJson(KEY, entries);
    render();
    toast("è¿½åŠ ã—ãŸã‚ˆï¼");
    clearInputs();
  }

  function delEntry(id){
    const before = entries.length;
    entries = entries.filter(x => x.id !== id);
    if(entries.length !== before){
      saveJson(KEY, entries);
      render();
      toast("ã‘ã—ãŸã‚ˆ");
    }
  }

  function wipeAll(){
    if(!confirm("ã»ã‚“ã¨ã†ã«å…¨éƒ¨ã‘ã™ï¼Ÿ")) return;
    entries = [];
    saveJson(KEY, entries);
    render();
    toast("å…¨éƒ¨ã‘ã—ãŸã‚ˆ");
  }

  function getFiltered(){
    if(range === "all") return entries;
    return entries.filter(e => isSameMonth(e.date));
  }

  function render(){
    el.unitPrice.value = String(unitPrice);
    el.rangeSel.value = range;

    const list = getFiltered();

    let sumIn = 0;
    let sumOut = 0;
    for(const e of list){
      if(e.type === "in") sumIn += (e.amount || 0);
      else sumOut += (e.amount || 0);
    }
    const net = sumIn - sumOut;

    el.sumIn.textContent = yen(sumIn);
    el.sumOut.textContent = yen(sumOut);
    el.sumNet.textContent = yen(net);
    el.sumNet.classList.toggle("good", net >= 0);
    el.sumNet.classList.toggle("bad", net < 0);

    el.tbody.innerHTML = "";
    for(const e of list){
      const tr = document.createElement("tr");

      const tdDate = document.createElement("td");
      tdDate.textContent = e.date || "";
      tr.appendChild(tdDate);

      const tdDesc = document.createElement("td");
      tdDesc.textContent = e.desc || "";
      tr.appendChild(tdDesc);

      const tdType = document.createElement("td");
      tdType.innerHTML = e.type === "in"
        ? `<span class="good">åå…¥</span>`
        : `<span class="bad">æ”¯å‡º</span>`;
      tr.appendChild(tdType);

      const tdAmt = document.createElement("td");
      tdAmt.className = "right";
      tdAmt.innerHTML = e.type === "in"
        ? `<span class="good">+${yen(e.amount || 0)}</span>`
        : `<span class="bad">-${yen(e.amount || 0)}</span>`;
      tr.appendChild(tdAmt);

      const tdAct = document.createElement("td");
      tdAct.className = "right";
      const b = document.createElement("button");
      b.className = "btn btnGhost";
      b.style.padding = "8px 10px";
      b.style.borderRadius = "999px";
      b.style.boxShadow = "none";
      b.style.fontSize = "12px";
      b.textContent = "å‰Šé™¤";
      b.addEventListener("click", () => delEntry(e.id));
      tdAct.appendChild(b);
      tr.appendChild(tdAct);

      el.tbody.appendChild(tr);
    }

    if(list.length === 0){
      el.hint.textContent = "ã¾ã è¨˜éŒ²ãŒãªã„ã‚ˆã€‚ä¸Šã‹ã‚‰è¿½åŠ ã—ã¦ã­ï¼";
    }else{
      el.hint.textContent = `è¡¨ç¤ºä¸­ï¼š${list.length}ä»¶`;
    }
  }

  // ===== wiring =====
  el.date.value = todayISO();
  el.unitPrice.value = String(unitPrice);

  el.tabChore.addEventListener("click", () => setMode("chore"));
  el.tabIncome.addEventListener("click", () => setMode("income"));
  el.tabExpense.addEventListener("click", () => setMode("expense"));

  el.addBtn.addEventListener("click", addEntry);
  el.clearBtn.addEventListener("click", clearInputs);
  el.wipeBtn.addEventListener("click", wipeAll);

  el.rangeSel.addEventListener("change", () => {
    range = el.rangeSel.value;
    render();
  });

  el.unitPrice.addEventListener("change", () => {
    const v = Math.max(0, Math.trunc(num(el.unitPrice.value)));
    unitPrice = v;
    saveJson(KEY_UNIT, unitPrice);
    render();
    toast("1å›ã®é‡‘é¡ã‚’ä¿å­˜ã—ãŸã‚ˆ");
  });

  // ===== init =====
  render();

  // ===== shared sync (keep warm + fast initial load) =====
  const SYNC = {
    lastEntriesStr: "",
    lastUnitStr: "",
    fail: 0,
    pollTimer: null,
    keepAliveTimer: null,
  };

  function safeStringify(x){
    try{ return JSON.stringify(x); }catch{ return ""; }
  }

  function sleep(ms){
    return new Promise(r => setTimeout(r, ms));
  }

  function applyRemote(remoteEntries, remoteUnit){
    let changed = false;

    if(Array.isArray(remoteEntries)){
      const s = safeStringify(remoteEntries);
      if(s && s !== SYNC.lastEntriesStr){
        SYNC.lastEntriesStr = s;
        entries = remoteEntries;
        storeLocal(KEY, entries); // local only (avoid echo)
        changed = true;
      }
    }

    if(typeof remoteUnit === "number" && remoteUnit >= 0){
      const s = String(remoteUnit);
      if(s !== SYNC.lastUnitStr){
        SYNC.lastUnitStr = s;
        unitPrice = Math.trunc(remoteUnit);
        storeLocal(KEY_UNIT, unitPrice); // local only (avoid echo)
        // UIåæ˜ ï¼ˆå…ƒã®ä»•æ§˜ã©ãŠã‚Š input ã®å€¤ã‚‚åˆã‚ã›ã‚‹ï¼‰
        if(el && el.unitPrice) el.unitPrice.value = String(unitPrice);
        changed = true;
      }
    }

    if(changed) render();
  }

  // --- keep warm ping ---
  function keepAliveInterval(){
    return document.hidden ? 10 * 60 * 1000 : 3 * 60 * 1000;
  }
  function scheduleKeepAlive(){
    clearTimeout(SYNC.keepAliveTimer);
    SYNC.keepAliveTimer = setTimeout(async () => {
      await remotePing();
      scheduleKeepAlive();
    }, keepAliveInterval());
  }

  // --- polling ---
  function basePollInterval(){
    return document.hidden ? 20000 : 2000;
  }
  function backoff(ms){
    if(SYNC.fail >= 4) return Math.max(ms, 10000);
    if(SYNC.fail >= 2) return Math.max(ms, 5000);
    return ms;
  }

  async function pollOnce(){
    const [re, ru] = await Promise.all([
      remoteGet(KEY),
      remoteGet(KEY_UNIT),
    ]);

    // ã©ã¡ã‚‰ã‹ãŒå–ã‚Œã‚Œã°æˆåŠŸæ‰±ã„ï¼ˆãƒãƒƒãƒˆã‚„GASãŒä¸å®‰å®šãªæ™‚ã®ãŸã‚ï¼‰
    const ok = (re !== null) || (ru !== null);
    if(ok){
      SYNC.fail = 0;
      applyRemote(re, ru);
      return true;
    }else{
      SYNC.fail = Math.min(SYNC.fail + 1, 6);
      return false;
    }
  }

  async function tick(){
    await pollOnce();
    const ms = backoff(basePollInterval());
    clearTimeout(SYNC.pollTimer);
    SYNC.pollTimer = setTimeout(tick, ms);
  }

  async function warmUpThenInitialLoad(){
    // pingãŒè¿”ã‚‹ã¾ã§è»½ãè©¦ã™ï¼ˆæœ€å¤§3å›ï¼‰
    for(let i=0;i<3;i++){
      const ok = await remotePing();
      if(ok) break;
      await sleep(400);
    }
    await pollOnce();
  }

  document.addEventListener("visibilitychange", () => {
    // è¡¨ç¤º/éè¡¨ç¤ºãŒåˆ‡ã‚Šæ›¿ã‚ã£ãŸã‚‰ã€ã™ãæœ€é©åŒ–
    scheduleKeepAlive();
    clearTimeout(SYNC.pollTimer);
    SYNC.pollTimer = setTimeout(tick, 50);
  });

  // åˆæœŸå€¤ï¼ˆç„¡é§„ãªæç”»ã‚’æ¸›ã‚‰ã™ãŸã‚ï¼‰
  SYNC.lastEntriesStr = safeStringify(entries);
  SYNC.lastUnitStr = String(unitPrice);

  scheduleKeepAlive();
  warmUpThenInitialLoad().then(() => {
    tick();
  });

})();
</script>
</body>
</html>
