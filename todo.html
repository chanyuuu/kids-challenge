<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ä»Šæ—¥ã®ã‚„ã‚‹ã“ã¨ãƒãƒ£ãƒ¬ãƒ³ã‚¸</title>
  <style>
    :root{
      --bg:#fff7d6; --card:#fff; --ink:#2b2b2b;
      --shadow:0 10px 22px rgba(0,0,0,.10);
      --radius:18px;
      --pink:#ff5aa5; --blue:#3aa0ff; --green:#22c55e; --orange:#ff8a3d; --purple:#8b5cf6;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
      background:
        radial-gradient(circle at 20% 10%, rgba(255,90,165,.25), transparent 40%),
        radial-gradient(circle at 90% 20%, rgba(58,160,255,.25), transparent 45%),
        radial-gradient(circle at 40% 95%, rgba(255,138,61,.22), transparent 45%),
        var(--bg);
      color:var(--ink);
      padding-bottom: 110px;
    }
    .wrap{max-width:520px;margin:0 auto;padding:16px 14px 40px;}
    .title{display:flex;align-items:center;gap:10px;margin:8px 0 10px;}
    .badge{width:46px;height:46px;border-radius:14px;background:linear-gradient(135deg,var(--pink),var(--purple));display:grid;place-items:center;box-shadow:var(--shadow);}
    .badge span{font-size:24px;filter:drop-shadow(0 2px 0 rgba(0,0,0,.12));}
    h1{margin:0;font-size:22px;line-height:1.2;}
    .sub{margin:2px 0 0;font-size:12px;opacity:.8;}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;border:2px solid rgba(255,255,255,.6);}
    .stack{display:grid;gap:12px;}
    .progressRow{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px;}
    .percent{font-weight:900;font-size:18px;padding:6px 10px;border-radius:999px;background:rgba(0,0,0,.05);}
    .stars{display:flex;gap:4px;font-size:18px;user-select:none;}
    .bar{height:14px;width:100%;background:rgba(0,0,0,.07);border-radius:999px;overflow:hidden;}
    .bar>div{height:100%;width:0%;border-radius:999px;background:linear-gradient(90deg,var(--blue),var(--green),var(--orange));transition:width .25s ease;}
    .cheer{margin-top:10px;padding:10px 12px;border-radius:14px;background:rgba(34,197,94,.12);border:2px dashed rgba(34,197,94,.35);display:none;font-weight:900;}
    .cheer.show{display:block;}
    .warn{margin-top:10px;padding:10px 12px;border-radius:14px;background:rgba(255,90,165,.10);border:2px dashed rgba(255,90,165,.35);display:none;font-weight:800;}
    .warn.show{display:block;}

    .rewardBox{margin-top:10px;padding:12px;border-radius:16px;background:rgba(255,138,61,.10);border:2px dashed rgba(255,138,61,.35);display:none;}
    .rewardBox.show{display:block;}
    .rewardTitle{font-weight:900;margin-bottom:6px;}
    .rewardText{font-size:18px;font-weight:900;line-height:1.25;}
    .rewardBtns{display:flex;gap:8px;margin-top:10px;}
    .tiny{font-size:12px;opacity:.8;margin-top:6px;line-height:1.35;}

    .inputRow{display:flex;gap:8px;align-items:center;}
    input[type="text"], textarea{
      width:100%;padding:12px;border-radius:14px;border:2px solid rgba(0,0,0,.12);
      outline:none;font-size:15px;background:rgba(255,255,255,.9);
    }
    textarea{min-height:70px;resize:vertical;}
    input:focus, textarea:focus{border-color:rgba(58,160,255,.65);box-shadow:0 0 0 4px rgba(58,160,255,.18);}
    .btn{border:none;border-radius:14px;padding:12px;font-weight:900;cursor:pointer;box-shadow:0 8px 18px rgba(0,0,0,.12);user-select:none;touch-action:manipulation;white-space:nowrap;}
    .btnAdd{background:linear-gradient(135deg,var(--blue),var(--purple));color:#fff;}
    .btnReset{background:rgba(0,0,0,.07);color:var(--ink);box-shadow:none;border:2px solid rgba(0,0,0,.10);}
    .btnMini{padding:10px;border-radius:14px;box-shadow:none;border:2px solid rgba(0,0,0,.10);background:#fff;font-weight:900;}
    .btn:active{transform:translateY(1px);}

    ul{list-style:none;padding:0;margin:0;display:grid;gap:10px;}
    .item{display:flex;gap:10px;align-items:flex-start;padding:12px;border-radius:16px;background:rgba(0,0,0,.03);border:2px solid rgba(0,0,0,.06);}
    .item.done{opacity:.78;background:rgba(34,197,94,.08);border-color:rgba(34,197,94,.22);}
    .check{width:26px;height:26px;border-radius:8px;border:2px solid rgba(0,0,0,.22);display:grid;place-items:center;flex:0 0 auto;margin-top:2px;background:#fff;}
    .item.done .check{background:rgba(34,197,94,.18);border-color:rgba(34,197,94,.55);}
    .check input{width:18px;height:18px;margin:0;}
    .text{flex:1;font-size:16px;font-weight:900;line-height:1.25;}
    .item.done .text{text-decoration:line-through;}
    .miniBtns{display:flex;gap:6px;align-items:center;flex:0 0 auto;}
    .pill{font-size:12px;font-weight:900;border-radius:999px;padding:7px 10px;border:2px solid rgba(0,0,0,.10);background:#fff;cursor:pointer;user-select:none;}
    .pillDel{background:rgba(255,90,165,.12);border-color:rgba(255,90,165,.35);}
    .footerHint{font-size:12px;opacity:.8;margin:8px 2px 0;line-height:1.4;}
    details{margin-top:10px;}
    details>summary{cursor:pointer;font-weight:900;padding:10px 12px;border-radius:14px;background:rgba(0,0,0,.05);user-select:none;}

    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:rgba(0,0,0,.85);color:#fff;padding:10px 12px;border-radius:999px;
      font-weight:900;font-size:13px;opacity:0;pointer-events:none;transition:opacity .2s ease, transform .2s ease;z-index:999;
    }
    .toast.show{opacity:1;transform:translateX(-50%) translateY(-2px);}

    .backBar{
      position:fixed;
      left:0; right:0; bottom:0;
      padding: 12px 12px calc(12px + env(safe-area-inset-bottom));
      background: rgba(255,255,255,.88);
      backdrop-filter: blur(10px);
      border-top: 2px solid rgba(0,0,0,.08);
      z-index: 998;
    }
    .backBtn{
      display:block;
      max-width:520px;
      margin:0 auto;
      text-decoration:none;
      text-align:center;
      padding: 14px 12px;
      border-radius: 16px;
      font-weight: 950;
      color:#fff;
      background: linear-gradient(135deg, var(--blue), var(--purple));
      box-shadow: var(--shadow);
    }

    .commentPreview{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      background:rgba(58,160,255,.08);
      border:2px dashed rgba(58,160,255,.28);
      display:none;
    }
    .commentPreview.show{display:block;}
    .commentTitle{font-weight:950;margin-bottom:8px;}
    .commentList{display:grid;gap:8px;margin:0;padding:0;list-style:none;}
    .cItem{
      display:flex;gap:8px;align-items:flex-start;
      padding:10px 10px;border-radius:14px;
      background:rgba(255,255,255,.85);
      border:2px solid rgba(0,0,0,.06);
    }
    .cText{flex:1;font-weight:900;line-height:1.25;}
    .cDel{
      flex:0 0 auto;
      border:none;
      border-radius:999px;
      padding:6px 10px;
      font-weight:950;
      cursor:pointer;
      background:rgba(255,90,165,.12);
      border:2px solid rgba(255,90,165,.35);
    }

    .confettiLayer{
      position:fixed;
      inset:0;
      pointer-events:none;
      overflow:hidden;
      z-index: 2000;
    }
    .confetti{
      position:absolute;
      left:50%;
      top:50%;
      width:10px;
      height:14px;
      border-radius:3px;
      opacity:.95;
      background: var(--c);
      filter: drop-shadow(0 2px 0 rgba(0,0,0,.08));
      transform: translate(-50%, -50%);
      animation: confettiPop 900ms cubic-bezier(.18,.85,.2,1) forwards;
    }
    @keyframes confettiPop{
      0%{ transform: translate(-50%, -50%) translate(0px, 0px) rotate(var(--r)); opacity:1; }
      70%{ transform: translate(-50%, -50%) translate(var(--dx), var(--dy)) rotate(calc(var(--r) + 220deg)); opacity:1; }
      100%{ transform: translate(-50%, -50%) translate(var(--dx), calc(var(--dy) + 80px)) rotate(calc(var(--r) + 320deg)); opacity:0; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">
      <div class="badge"><span>â­</span></div>
      <div>
        <h1>ä»Šæ—¥ã®ã‚„ã‚‹ã“ã¨ãƒãƒ£ãƒ¬ãƒ³ã‚¸</h1>
        <div class="sub">ãƒã‚§ãƒƒã‚¯ã—ã¦ã€é”æˆç‡ã‚’ã‚ã’ã‚ˆã†ï¼</div>
      </div>
    </div>

    <div class="stack">
      <div class="card">
        <div class="progressRow">
          <div class="percent" id="percent">0%</div>
          <div class="stars" id="stars"></div>
        </div>
        <div class="bar"><div id="barFill"></div></div>

        <div class="cheer" id="cheer">ğŸ‰ ãœã‚“ã¶ã§ããŸï¼ã™ã”ã„ï¼</div>

        <div class="commentPreview" id="commentPreview">
          <div class="commentTitle">ğŸ’¬ ãŠã†ã¡ã®äººã‹ã‚‰ã®ã‚³ãƒ¡ãƒ³ãƒˆ</div>
          <ul class="commentList" id="commentList"></ul>
        </div>

        <div class="rewardBox" id="rewardBox">
          <div class="rewardTitle">ğŸ ä»Šæ—¥ã®ã”ã»ã†ã³ã¯â€¦</div>
          <div class="rewardText" id="rewardText"></div>
          <div class="rewardBtns">
            <button class="btn btnMini" id="hideRewardBtn">ğŸ™ˆ ã‹ãã™</button>
          </div>
          <div class="tiny">â€»ã”ã»ã†ã³ã¯ã€è¦ªå­ã§OKã®ã¨ãã ã‘ã­ï¼</div>
        </div>

        <div class="warn" id="storageWarn">
          âš ï¸ ã“ã®ç’°å¢ƒã¯ä¿å­˜ãŒã§ããªã„ã¿ãŸã„ã€‚<br>
          ï¼ˆSafariã®ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ/ã‚¢ãƒ—ãƒªå†…ãƒ–ãƒ©ã‚¦ã‚¶ã ã¨èµ·ããŒã¡ï¼‰<br>
          é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã®Safari/Chromeã§é–‹ãã¨ä¿å­˜ã§ãã¾ã™ã€‚
        </div>
      </div>

      <div class="card">
        <div class="inputRow">
          <input id="taskInput" type="text" maxlength="30" placeholder="ã‚„ã‚‹ã“ã¨ã‚’å…¥ã‚Œã¦ã­ï¼ˆä¾‹ï¼šã—ã‚…ãã ã„ï¼‰" />
          <button class="btn btnAdd" id="addBtn">ï¼‹ è¿½åŠ </button>
        </div>

        <div class="footerHint">
          ãƒ’ãƒ³ãƒˆï¼š1æ—¥3ã€œ5ã“ãã‚‰ã„ãŒã¡ã‚‡ã†ã©ã„ã„ã‚ˆã€‚<br>
          ä¾‹ï¼šã—ã‚…ãã ã„ï¼æ˜æ—¥ã®ã˜ã‚…ã‚“ã³ï¼ãŠã¦ã¤ã ã„
        </div>

        <details>
          <summary>ğŸ ã”ã»ã†ã³ã‚’ã¸ã‚“ã—ã‚…ã†ã™ã‚‹</summary>
          <div style="margin-top:10px;">
            <textarea id="rewardsInput" placeholder="1è¡Œã«1ã¤æ›¸ãï¼ˆä¾‹ï¼šã‚²ãƒ¼ãƒ 10åˆ†ï¼‹ï¼ã‚¢ã‚¤ã‚¹ï¼ã„ã£ã—ã‚‡ã«æ˜ ç”»ï¼‰"></textarea>
            <div style="display:flex; gap:10px; margin-top:10px;">
              <button class="btn btnMini btnAdd" id="saveRewardsBtn" style="flex:1;">ğŸ’¾ ã”ã»ã†ã³ä¿å­˜</button>
              <button class="btn btnMini" id="resetRewardsBtn" style="flex:1;">â†©ï¸ ã‚‚ã¨ã«ã‚‚ã©ã™</button>
            </div>
            <div class="tiny">ã“ã“ã§æ›¸ã„ãŸã”ã»ã†ã³ãŒã€å…¨éƒ¨é”æˆã—ãŸã¨ãã«ãƒ©ãƒ³ãƒ€ãƒ ã§å‡ºã‚‹ã‚ˆã€‚</div>
          </div>
        </details>

        <details>
          <summary>ğŸ’¬ ãŠã†ã¡ã®äººã‹ã‚‰ã®ã‚³ãƒ¡ãƒ³ãƒˆ</summary>
          <div style="margin-top:10px; display:grid; gap:10px;">
            <div class="inputRow">
              <input id="commentInput" type="text" maxlength="160" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ï¼ˆä¾‹ï¼šã‚ˆããŒã‚“ã°ã£ãŸã­ï¼ï¼‰" />
              <button class="btn btnAdd" id="addCommentBtn">ï¼‹ è¿½åŠ </button>
            </div>
            <div class="tiny">â€»è¿½åŠ ã—ãŸã‚³ãƒ¡ãƒ³ãƒˆã¯ä¸Šã®ã‚«ãƒ¼ãƒ‰ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚åˆ¥ç«¯æœ«ã§ã‚‚å…±æœ‰ã§ãã¾ã™ï¼ˆå…±æœ‰ãŒä½¿ãˆã‚‹å ´åˆï¼‰ã€‚</div>
          </div>
        </details>
      </div>

      <div class="card">
        <ul id="list"></ul>
        <div style="display:flex; gap:10px; margin-top:12px;">
          <button class="btn btnReset" id="resetBtn" style="flex:1;">ğŸ”„ ãƒªã‚»ãƒƒãƒˆï¼ˆæ˜æ—¥ç”¨ï¼‰</button>
        </div>
        <div class="footerHint">â€»ä¿å­˜ã•ã‚Œã‚‹ã®ã§ã€ãƒšãƒ¼ã‚¸ã‚’é–‰ã˜ã¦ã‚‚æ®‹ã‚‹ã‚ˆã€‚</div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">ä¿å­˜ã—ãŸã‚ˆï¼</div>
  <div class="backBar"><a class="backBtn" href="index.html">ğŸ  ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</a></div>
  <div class="confettiLayer" id="confettiLayer"></div>

<script>
(async () => {
  function makeId(){
    const hasCrypto = (typeof crypto !== "undefined");
    if (hasCrypto && typeof crypto.randomUUID === "function") return crypto.randomUUID();
    return "id-" + Math.random().toString(16).slice(2) + "-" + Date.now().toString(16);
  }

  function canUseStorage(){
    try{
      const k = "__test__" + makeId();
      localStorage.setItem(k, "1");
      localStorage.removeItem(k);
      return true;
    }catch{
      return false;
    }
  }
  const STORAGE_OK = canUseStorage();

  const memStore = {};
  function loadJson(key){
    try{
      if(STORAGE_OK){
        const raw = localStorage.getItem(key);
        return raw ? JSON.parse(raw) : null;
      }else{
        return (key in memStore) ? memStore[key] : null;
      }
    }catch{
      return null;
    }
  }

  const API_URL = "https://script.google.com/macros/s/AKfycbxVT20cF2cEQwbXWEn4_MlvKBDAq9YTW6mcewmPz8imWyrR39MnuqdPxQ9ZXO9Q91JG/exec";
  const API_TOKEN = "kids-2026-0130-asahi-0620";

  async function apiPost(payload){
    try{
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({ token: API_TOKEN, ...payload })
      });
      return await res.json();
    }catch(err){
      return { ok:false, error: String(err?.message || err) };
    }
  }

  // === è¿½åŠ ï¼špingã‚’ã€ŒæˆåŠŸ/å¤±æ•—ã€ã¾ã§è¿”ã™ï¼ˆèµ·å‹•ç¢ºèªã«ä½¿ã†ï¼‰ ===
  async function remotePing(){
    try{
      const url = `${API_URL}?mode=ping&token=${encodeURIComponent(API_TOKEN)}&_=${Date.now()}`;
      const res = await fetch(url, { cache: "no-store" });
      // pingã¯ãƒ¬ã‚¹ãƒãƒ³ã‚¹å†…å®¹ã¯ä½¿ã‚ãªã„ãŒã€æˆåŠŸã—ãŸã‹ã ã‘æ¬²ã—ã„
      return res.ok;
    }catch{
      return false;
    }
  }

  async function remoteLoadAll(){
    try{
      const url = `${API_URL}?mode=loadAll&token=${encodeURIComponent(API_TOKEN)}&_=${Date.now()}`;
      const res = await fetch(url, { cache: "no-store" });
      const j = await res.json();
      if(j && j.ok) return j;
      return null;
    }catch{
      return null;
    }
  }

  async function remoteSet(key, value){
    await apiPost({ mode:"save", key, data: value });
  }

  function saveJson(key, value){
    try{
      if(STORAGE_OK){
        localStorage.setItem(key, JSON.stringify(value));
      }else{
        memStore[key] = value;
      }
    }catch{}
    remoteSet(key, value);
  }

  const KEY_TASKS = "kid_challenge_tasks_v3";
  const KEY_REWARDS = "kid_challenge_rewards_v3";
  const KEY_LAST_REWARD = "kid_challenge_last_reward_v3";
  const KEY_SHOWN_REWARD = "kid_challenge_shown_reward_v3";
  const KEY_COMMENTS = "kid_challenge_comments_v2";

  function sanitizeText(s){
    return String(s).trim().replace(/\s+/g, " ").slice(0, 30);
  }
  function sanitizeComment(s){
    return String(s ?? "").replace(/\r/g, "").trim().replace(/\s+/g, " ").slice(0, 160);
  }

  // --- ãƒ­ãƒ¼ã‚«ãƒ«ï¼ˆå³è¡¨ç¤ºç”¨ï¼‰ ---
  let tasks = loadJson(KEY_TASKS);
  if(!Array.isArray(tasks)) tasks = [
    { id: makeId(), text: "ã—ã‚…ãã ã„", done: false },
    { id: makeId(), text: "æ˜æ—¥ã®ã˜ã‚…ã‚“ã³", done: false },
    { id: makeId(), text: "ãŠã¦ã¤ã ã„ï¼ˆãŠçš¿ã¯ã“ã³ï¼‰", done: false },
  ];
  tasks = tasks.filter(x => x && typeof x.text === "string").map(x => ({
    id: String(x.id ?? makeId()),
    text: sanitizeText(x.text),
    done: Boolean(x.done)
  }));

  let rewards = loadJson(KEY_REWARDS);
  if(!Array.isArray(rewards)) rewards = [
    "ã‚²ãƒ¼ãƒ 10åˆ†ï¼‹","ã‚¢ã‚¤ã‚¹ï¼ˆ1ã¤ï¼‰","ã„ã£ã—ã‚‡ã«æ˜ ç”»ï¼ˆ1æœ¬ï¼‰",
    "ã™ããªãŠã‚„ã¤ã‚¿ã‚¤ãƒ ","ãŠãµã‚ã§ã‚ã‚ã‚ã‚ã‚¿ã‚¤ãƒ ","ã‚ã—ãŸã®ã‚ã•ã€5åˆ†ã ã‘ã‚´ãƒ­ã‚´ãƒ­OK"
  ];
  rewards = rewards.map(x => String(x).trim()).filter(x => x.length > 0).slice(0, 50);

  let comments = loadJson(KEY_COMMENTS);
  if(!Array.isArray(comments)) comments = [];
  comments = comments
    .filter(x => x && typeof x.text === "string")
    .map(x => ({ id: String(x.id ?? makeId()), text: sanitizeComment(x.text), ts: Number(x.ts ?? Date.now()) }))
    .filter(x => x.text.length > 0)
    .slice(0, 50);

  // DOM
  const elList = document.getElementById("list");
  const elInput = document.getElementById("taskInput");
  const elAdd = document.getElementById("addBtn");
  const elReset = document.getElementById("resetBtn");
  const elPercent = document.getElementById("percent");
  const elBar = document.getElementById("barFill");
  const elStars = document.getElementById("stars");
  const elCheer = document.getElementById("cheer");

  const elRewardBox = document.getElementById("rewardBox");
  const elRewardText = document.getElementById("rewardText");
  const elHideReward = document.getElementById("hideRewardBtn");

  const elRewardsInput = document.getElementById("rewardsInput");
  const elSaveRewards = document.getElementById("saveRewardsBtn");
  const elResetRewards = document.getElementById("resetRewardsBtn");

  const elToast = document.getElementById("toast");
  const elWarn = document.getElementById("storageWarn");

  const elConfetti = document.getElementById("confettiLayer");

  const elCommentPreview = document.getElementById("commentPreview");
  const elCommentList = document.getElementById("commentList");
  const elCommentInput = document.getElementById("commentInput");
  const elAddCommentBtn = document.getElementById("addCommentBtn");

  function toast(msg){
    elToast.textContent = msg;
    elToast.classList.add("show");
    clearTimeout(toast._t);
    toast._t = setTimeout(() => elToast.classList.remove("show"), 950);
  }

  function getProgress(){
    const total = tasks.length;
    const done = tasks.filter(t => t.done).length;
    const pct = total === 0 ? 0 : Math.round((done / total) * 100);
    const allDone = total > 0 && done === total;
    return { total, done, pct, allDone };
  }

  function pickReward(){
    if(!rewards || rewards.length === 0) return "ã”ã»ã†ã³ãŒãªã„ã‚ˆï¼(ã¸ã‚“ã—ã‚…ã†ã—ã¦ã­)";
    return rewards[Math.floor(Math.random() * rewards.length)];
  }

  function showReward(forceNew=false){
    const { allDone } = getProgress();
    if(!allDone) return;

    let last = STORAGE_OK ? localStorage.getItem(KEY_LAST_REWARD) : null;
    if(forceNew || !last){
      last = pickReward();
      if(STORAGE_OK) localStorage.setItem(KEY_LAST_REWARD, last);
    }

    elRewardText.textContent = last;

    const shown = STORAGE_OK ? localStorage.getItem(KEY_SHOWN_REWARD) : "1";
    const visible = (shown === null) ? true : (shown === "1");
    elRewardBox.classList.toggle("show", visible);

    if(visible && navigator.vibrate) navigator.vibrate([60,40,60]);
  }

  function launchConfetti(){
    elConfetti.innerHTML = "";
    const colors = ["var(--pink)","var(--blue)","var(--green)","var(--orange)","var(--purple)"];
    const pieces = 90;

    for(let i=0;i<pieces;i++){
      const d = document.createElement("div");
      d.className = "confetti";

      const c = colors[Math.floor(Math.random() * colors.length)];
      const r = Math.floor(Math.random() * 360) + "deg";

      const angle = Math.random() * Math.PI * 2;
      const dist = 80 + Math.random() * 220;
      const dx = Math.cos(angle) * dist;
      const dy = Math.sin(angle) * dist * 0.7;

      const w = 8 + Math.floor(Math.random()*8);
      const h = 10 + Math.floor(Math.random()*10);
      d.style.width = w + "px";
      d.style.height = h + "px";

      d.style.setProperty("--c", c);
      d.style.setProperty("--r", r);
      d.style.setProperty("--dx", dx.toFixed(0) + "px");
      d.style.setProperty("--dy", dy.toFixed(0) + "px");
      d.style.animationDelay = (Math.random() * 60).toFixed(0) + "ms";

      elConfetti.appendChild(d);
    }

    clearTimeout(launchConfetti._t);
    launchConfetti._t = setTimeout(() => { elConfetti.innerHTML = ""; }, 980);
  }

  function renderComments(){
    elCommentList.innerHTML = "";
    if(!comments || comments.length === 0){
      elCommentPreview.classList.remove("show");
      return;
    }
    elCommentPreview.classList.add("show");

    for(const c of comments){
      const li = document.createElement("li");
      li.className = "cItem";

      const t = document.createElement("div");
      t.className = "cText";
      t.textContent = c.text;

      const del = document.createElement("button");
      del.className = "cDel";
      del.textContent = "ğŸ—‘ï¸";
      del.addEventListener("click", () => {
        comments = comments.filter(x => x.id !== c.id);
        saveJson(KEY_COMMENTS, comments);
        toast(STORAGE_OK ? "ä¿å­˜ã—ãŸã‚ˆï¼" : "ä¿å­˜ã§ããªã„ã‘ã©å‹•ã„ã¦ã‚‹ã‚ˆï¼");
        renderComments();
      });

      li.appendChild(t);
      li.appendChild(del);
      elCommentList.appendChild(li);
    }
  }

  let lastAllDone = false;

  function render(){
    elList.innerHTML = "";
    if(tasks.length === 0){
      const li = document.createElement("li");
      li.className = "item";
      li.innerHTML = `<div class="text">ã¾ãšã¯ã€Œï¼‹ è¿½åŠ ã€ã—ã¦ã­ï¼</div>`;
      elList.appendChild(li);
    }else{
      for(const t of tasks){
        const li = document.createElement("li");
        li.className = "item" + (t.done ? " done" : "");

        const check = document.createElement("div");
        check.className = "check";
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = t.done;
        cb.addEventListener("change", () => {
          t.done = cb.checked;
          saveJson(KEY_TASKS, tasks);
          toast(STORAGE_OK ? "ä¿å­˜ã—ãŸã‚ˆï¼" : "ä¿å­˜ã§ããªã„ã‘ã©å‹•ã„ã¦ã‚‹ã‚ˆï¼");
          render();
        });
        check.appendChild(cb);

        const text = document.createElement("div");
        text.className = "text";
        text.textContent = t.text;

        const btns = document.createElement("div");
        btns.className = "miniBtns";
        const del = document.createElement("button");
        del.className = "pill pillDel";
        del.textContent = "ğŸ—‘ï¸";
        del.addEventListener("click", () => {
          tasks = tasks.filter(x => x.id !== t.id);
          saveJson(KEY_TASKS, tasks);
          toast(STORAGE_OK ? "ä¿å­˜ã—ãŸã‚ˆï¼" : "ä¿å­˜ã§ããªã„ã‘ã©å‹•ã„ã¦ã‚‹ã‚ˆï¼");
          render();
        });
        btns.appendChild(del);

        li.appendChild(check);
        li.appendChild(text);
        li.appendChild(btns);
        elList.appendChild(li);
      }
    }

    const { pct, allDone } = getProgress();
    elPercent.textContent = pct + "%";
    elBar.style.width = pct + "%";

    const stars = 5;
    const filled = Math.round((pct / 100) * stars);
    elStars.innerHTML = "";
    for(let i=0;i<stars;i++){
      const sp = document.createElement("span");
      sp.textContent = i < filled ? "â˜…" : "â˜†";
      elStars.appendChild(sp);
    }

    elCheer.classList.toggle("show", allDone);
    renderComments();

    if(allDone && !lastAllDone){
      launchConfetti();
    }
    lastAllDone = allDone;

    if(allDone){
      if(STORAGE_OK){
        if(!localStorage.getItem(KEY_LAST_REWARD)) localStorage.setItem(KEY_LAST_REWARD, pickReward());
        if(localStorage.getItem(KEY_SHOWN_REWARD) !== "0") localStorage.setItem(KEY_SHOWN_REWARD, "1");
      }
      showReward(false);
    }else{
      elRewardBox.classList.remove("show");
    }
  }

  function addTask(){
    const text = sanitizeText(elInput.value);
    if(!text){ toast("ãªã«ã‚’ã‚„ã‚‹ï¼Ÿå…¥ã‚Œã¦ã­ï¼"); elInput.focus(); return; }
    tasks.unshift({ id: makeId(), text, done:false });
    elInput.value = "";
    saveJson(KEY_TASKS, tasks);
    toast(STORAGE_OK ? "ä¿å­˜ã—ãŸã‚ˆï¼" : "ä¿å­˜ã§ããªã„ã‘ã©è¿½åŠ ã§ããŸã‚ˆï¼");
    render();
  }

  function addComment(){
    const text = sanitizeComment(elCommentInput.value);
    if(!text){ toast("ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥ã‚Œã¦ã­ï¼"); elCommentInput.focus(); return; }
    comments.unshift({ id: makeId(), text, ts: Date.now() });
    comments = comments.slice(0, 50);
    elCommentInput.value = "";
    saveJson(KEY_COMMENTS, comments);
    toast(STORAGE_OK ? "ã‚³ãƒ¡ãƒ³ãƒˆä¿å­˜ã—ãŸã‚ˆï¼" : "ä¿å­˜ã§ããªã„ã‘ã©å…¥ã‚ŒãŸã‚ˆï¼");
    renderComments();
  }

  // Events
  elAdd.addEventListener("click", addTask);
  elInput.addEventListener("keydown", (e) => { if(e.key === "Enter"){ e.preventDefault(); addTask(); } });

  elAddCommentBtn.addEventListener("click", addComment);
  elCommentInput.addEventListener("keydown", (e) => { if(e.key === "Enter"){ e.preventDefault(); addComment(); } });

  elReset.addEventListener("click", () => {
    tasks = tasks.map(t => ({...t, done:false}));
    saveJson(KEY_TASKS, tasks);
    if(STORAGE_OK){
      localStorage.removeItem(KEY_LAST_REWARD);
      localStorage.removeItem(KEY_SHOWN_REWARD);
    }
    toast("ãƒªã‚»ãƒƒãƒˆã—ãŸã‚ˆï¼");
    lastAllDone = false;
    render();
  });

  elHideReward.addEventListener("click", () => {
    if(STORAGE_OK) localStorage.setItem(KEY_SHOWN_REWARD, "0");
    elRewardBox.classList.remove("show");
    toast("ã‹ãã—ãŸã‚ˆï¼");
  });

  elSaveRewards.addEventListener("click", () => {
    const lines = elRewardsInput.value.split("\n").map(s => s.trim()).filter(Boolean).slice(0,50);
    if(lines.length === 0){ toast("1è¡Œã«1ã¤ã€å…¥ã‚Œã¦ã­ï¼"); return; }
    rewards = lines;
    saveJson(KEY_REWARDS, rewards);
    if(STORAGE_OK) localStorage.removeItem(KEY_LAST_REWARD);
    toast(STORAGE_OK ? "ã”ã»ã†ã³ä¿å­˜OKï¼" : "ä¿å­˜ã§ããªã„ç’°å¢ƒã‹ã‚‚ï¼");
    if(getProgress().allDone) showReward(true);
  });

  elResetRewards.addEventListener("click", () => {
    rewards = [
      "ã‚²ãƒ¼ãƒ 10åˆ†ï¼‹","ã‚¢ã‚¤ã‚¹ï¼ˆ1ã¤ï¼‰","ã„ã£ã—ã‚‡ã«æ˜ ç”»ï¼ˆ1æœ¬ï¼‰",
      "ã™ããªãŠã‚„ã¤ã‚¿ã‚¤ãƒ ","ãŠãµã‚ã§ã‚ã‚ã‚ã‚ã‚¿ã‚¤ãƒ ","ã‚ã—ãŸã®ã‚ã•ã€5åˆ†ã ã‘ã‚´ãƒ­ã‚´ãƒ­OK"
    ];
    elRewardsInput.value = rewards.join("\n");
    saveJson(KEY_REWARDS, rewards);
    if(STORAGE_OK) localStorage.removeItem(KEY_LAST_REWARD);
    toast("ã‚‚ã¨ã«æˆ»ã—ãŸã‚ˆï¼");
    if(getProgress().allDone) showReward(true);
  });

  // ---- åˆæœŸè¡¨ç¤ºï¼šå³ renderï¼ˆçœŸã£ç™½æ™‚é–“ã‚’ãªãã™ï¼‰----
  elRewardsInput.value = rewards.join("\n");
  saveJson(KEY_TASKS, tasks);
  saveJson(KEY_REWARDS, rewards);
  saveJson(KEY_COMMENTS, comments);
  elWarn.classList.toggle("show", !STORAGE_OK);
  render();

  // ---- åŒæœŸï¼ˆloadAllï¼‰----
  let lastUpdatedAt = 0;

  function applyAll(all){
    if(Array.isArray(all.tasks)){
      const nt = all.tasks.filter(x => x && typeof x.text === "string").map(x => ({
        id: String(x.id ?? makeId()),
        text: sanitizeText(x.text),
        done: Boolean(x.done)
      }));
      tasks = nt;
      try{ if(STORAGE_OK) localStorage.setItem(KEY_TASKS, JSON.stringify(tasks)); else memStore[KEY_TASKS]=tasks; }catch{}
    }

    if(Array.isArray(all.comments)){
      const nc = all.comments
        .filter(x => x && typeof x.text === "string")
        .map(x => ({ id: String(x.id ?? makeId()), text: sanitizeComment(x.text), ts: Number(x.ts ?? Date.now()) }))
        .filter(x => x.text.length > 0)
        .slice(0, 50);
      comments = nc;
      try{ if(STORAGE_OK) localStorage.setItem(KEY_COMMENTS, JSON.stringify(comments)); else memStore[KEY_COMMENTS]=comments; }catch{}
    }

    if(Array.isArray(all.rewards)){
      const nr = all.rewards.map(x => String(x).trim()).filter(x => x.length > 0).slice(0,50);
      rewards = nr;
      try{ if(STORAGE_OK) localStorage.setItem(KEY_REWARDS, JSON.stringify(rewards)); else memStore[KEY_REWARDS]=rewards; }catch{}
      elRewardsInput.value = rewards.join("\n");
    }

    render();
  }

  // ===== è¿½åŠ ï¼šèµ·å‹•ç›´å¾Œã¯ã€ŒpingãŒè¿”ã£ã¦ã‹ã‚‰loadAllã€ =====
  async function warmUpThenLoadAll(){
    // æœ€å¤§3å›ã ã‘è»½ãè©¦ã™ï¼ˆå¤±æ•—ã—ã¦ã‚‚è«¦ã‚ã¦é€šå¸¸ã«é€²ã‚€ï¼‰
    for(let i=0;i<3;i++){
      const ok = await remotePing();
      if(ok) break;
      await new Promise(r => setTimeout(r, 400));
    }
    return await remoteLoadAll();
  }

  // ===== è¿½åŠ ï¼šæ¸©ã‚pingã‚’å®šæœŸå®Ÿè¡Œï¼ˆè¡¨ç¤ºä¸­3åˆ†/éè¡¨ç¤º10åˆ†ï¼‰ =====
  let keepAliveTimer = null;

  function keepAliveInterval(){
    return document.hidden ? 10 * 60 * 1000 : 3 * 60 * 1000;
  }

  function scheduleKeepAlive(){
    clearTimeout(keepAliveTimer);
    keepAliveTimer = setTimeout(async () => {
      // å¤±æ•—ã—ã¦ã‚‚æ¬¡å›ã«å›ã™ï¼ˆã“ã“ã¯è»½ã„ã®ã§ååˆ†ï¼‰
      await remotePing();
      scheduleKeepAlive();
    }, keepAliveInterval());
  }

  // ãƒãƒƒã‚¯ã‚ªãƒ•ä»˜ããƒãƒ¼ãƒªãƒ³ã‚°ï¼ˆ2ç§’ä¸­å¿ƒ / éè¡¨ç¤º20ç§’ï¼‰
  let fail = 0;
  let pollTimer = null;

  function baseInterval(){
    return document.hidden ? 20000 : 2000;
  }
  function backoff(ms){
    if(fail >= 4) return Math.max(ms, 10000);
    if(fail >= 2) return Math.max(ms, 5000);
    return ms;
  }

  async function tick(){
    const j = await remoteLoadAll();
    if(j && typeof j.updatedAt === "number"){
      fail = 0;
      if(j.updatedAt !== lastUpdatedAt){
        lastUpdatedAt = j.updatedAt;
        if(j.data && typeof j.data === "object"){
          applyAll(j.data);
        }
      }
    }else{
      fail = Math.min(fail + 1, 6);
    }

    const ms = backoff(baseInterval());
    clearTimeout(pollTimer);
    pollTimer = setTimeout(tick, ms);
  }

  document.addEventListener("visibilitychange", () => {
    // è¡¨ç¤ºçŠ¶æ…‹ãŒå¤‰ã‚ã£ãŸã‚‰ã€ãƒãƒ¼ãƒªãƒ³ã‚°/æ¸©ã‚pingã®é–“éš”ã‚’å³æœ€é©åŒ–
    clearTimeout(pollTimer);
    pollTimer = setTimeout(tick, 50);
    scheduleKeepAlive();
  });

  // èµ·å‹•æ™‚ï¼šã¾ãšæ¸©ã‚ã¦ã‹ã‚‰åˆå›loadAll
  scheduleKeepAlive();
  const first = await warmUpThenLoadAll();
  if(first && typeof first.updatedAt === "number"){
    lastUpdatedAt = first.updatedAt;
    if(first.data) applyAll(first.data);
  }

  // ç¶™ç¶šãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹
  tick();

})();
</script>
</body>
</html>
