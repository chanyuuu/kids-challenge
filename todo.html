<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ä»Šæ—¥ã®ã‚„ã‚‹ã“ã¨ãƒãƒ£ãƒ¬ãƒ³ã‚¸</title>

<style>
:root{
  --bg:#fff7d6; --card:#fff; --ink:#2b2b2b;
  --shadow:0 10px 22px rgba(0,0,0,.10);
  --radius:18px;
  --blue:#3aa0ff; --green:#22c55e; --pink:#ff5aa5; --purple:#8b5cf6;
}
*{box-sizing:border-box;}
body{margin:0;font-family:system-ui,-apple-system,"Noto Sans JP",sans-serif;background:var(--bg);color:var(--ink);padding-bottom:110px;}
.wrap{max-width:520px;margin:auto;padding:16px;}
.card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;margin-bottom:12px;}
h1{margin:0;font-size:22px;}
.sub{font-size:12px;opacity:.8;margin-bottom:10px;}
.row{display:flex;gap:8px;}
input{flex:1;padding:12px;border-radius:14px;border:2px solid rgba(0,0,0,.15);}
button{border:none;border-radius:14px;padding:12px;font-weight:900;cursor:pointer;}
.add{background:linear-gradient(135deg,var(--blue),var(--purple));color:#fff;}
.reset{background:#eee;}
.sync{background:#fff;border:2px solid rgba(0,0,0,.15);}
ul{list-style:none;padding:0;margin:0;display:grid;gap:8px;}
li{display:flex;gap:10px;align-items:center;padding:12px;border-radius:14px;background:rgba(0,0,0,.05);}
li.done{opacity:.6;text-decoration:line-through;}
.badge{
  display:inline-flex;align-items:center;gap:6px;
  padding:6px 10px;border-radius:999px;
  border:2px solid rgba(0,0,0,.12);
  background:#fff;font-weight:900;font-size:12px;
}
.badge.ok{border-color:rgba(34,197,94,.25);background:rgba(34,197,94,.08);}
.badge.wait{border-color:rgba(58,160,255,.25);background:rgba(58,160,255,.08);}
.badge.ng{border-color:rgba(255,90,165,.25);background:rgba(255,90,165,.08);}
.toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:#000;color:#fff;padding:10px 14px;border-radius:999px;font-size:13px;opacity:0;transition:.2s;z-index:999;}
.toast.show{opacity:1;}
.backBar{position:fixed;left:0;right:0;bottom:0;padding:12px;background:#fff;border-top:2px solid rgba(0,0,0,.1);z-index:998;}
.backBtn{display:block;text-align:center;padding:14px;border-radius:16px;background:linear-gradient(135deg,var(--blue),var(--purple));color:#fff;font-weight:900;text-decoration:none;}
</style>
</head>

<body>
<div class="wrap">
  <h1>â­ ä»Šæ—¥ã®ã‚„ã‚‹ã“ã¨ãƒãƒ£ãƒ¬ãƒ³ã‚¸</h1>
  <div class="sub">å®¶æ—ã§å…±æœ‰ã§ãã¾ã™</div>

  <div class="card">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
      <div class="badge wait" id="syncState">ğŸ”„ åŒæœŸï¼šå¾…æ©Ÿä¸­</div>
      <div style="font-size:12px;opacity:.75;font-weight:900;">è‡ªå‹•æ›´æ–°ï¼š2ç§’</div>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <input id="input" placeholder="ã‚„ã‚‹ã“ã¨ã‚’å…¥åŠ›">
      <button class="add" id="addBtn">ï¼‹</button>
    </div>
  </div>

  <div class="card">
    <ul id="list"></ul>
  </div>

  <div class="card">
    <button class="reset" id="resetBtn">ğŸ”„ å…¨éƒ¨ãƒªã‚»ãƒƒãƒˆ</button>
    <button class="sync" id="syncBtn">ğŸ”„ å…±æœ‰ã‚’æ›´æ–°</button>
  </div>
</div>

<div class="toast" id="toast"></div>
<div class="backBar">
  <a class="backBtn" href="index.html">ğŸ  ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</a>
</div>

<script>
(() => {
  /* ========= GAS è¨­å®š ========= */
  const API_URL = "https://script.google.com/macros/s/AKfycbxVT20cF2cEQwbXWEn4_MlvKBDAq9YTW6mcewmPz8imWyrR39MnuqdPxQ9ZXO9Q91JG/exec";
  const API_TOKEN = "kids-2026-0130-asahi-0620";
  const KEY_TASKS = "todo_tasks_v1";

  async function remoteGet(key){
    const url = API_URL + "?mode=load&token=" + encodeURIComponent(API_TOKEN) + "&key=" + encodeURIComponent(key);
    const r = await fetch(url, { cache: "no-store" });
    const j = await r.json();
    return j.ok ? j.data : null;
  }
  async function remoteSet(key,data){
    const r = await fetch(API_URL,{
      method:"POST",
      headers:{"Content-Type":"text/plain;charset=utf-8"},
      body:JSON.stringify({mode:"save",token:API_TOKEN,key,data})
    });
    return await r.json();
  }

  /* ========= state ========= */
  let tasks = [];
  let lastSig = "";         // ã‚µãƒ¼ãƒãƒ¼å†…å®¹ã®ç°¡æ˜“ç½²å
  let saving = false;       // ä¿å­˜ä¸­ã¯ãƒãƒ¼ãƒªãƒ³ã‚°åæ˜ ã‚’æŠ‘åˆ¶ï¼ˆä¸Šæ›¸ãäº‹æ•…é˜²æ­¢ï¼‰
  let lastOkAt = 0;         // æœ€å¾Œã«æˆåŠŸã—ãŸåŒæœŸæ™‚åˆ»ï¼ˆè¡¨ç¤ºç”¨ï¼‰

  const el = {
    input:document.getElementById("input"),
    list:document.getElementById("list"),
    toast:document.getElementById("toast"),
    syncState:document.getElementById("syncState"),
  };

  function toast(msg){
    el.toast.textContent = msg;
    el.toast.classList.add("show");
    clearTimeout(toast._t);
    toast._t = setTimeout(()=>el.toast.classList.remove("show"),1200);
  }

  function setState(kind, text){
    el.syncState.className = "badge " + kind;
    el.syncState.textContent = text;
  }

  function sigOf(arr){
    // å†…å®¹ãŒå¤‰ã‚ã£ãŸã‹ã ã‘çŸ¥ã‚ŠãŸã„ã®ã§è»½é‡ç½²å
    try{
      return JSON.stringify(arr).length + ":" + (arr?.[0]?.id ?? "") + ":" + (arr?.length ?? 0);
    }catch{
      return String(Date.now());
    }
  }

  function render(){
    el.list.innerHTML = "";
    if(tasks.length===0){
      el.list.innerHTML = "<li>ã¾ã ãªã„ã‚ˆ</li>";
      return;
    }
    tasks.forEach(t=>{
      const li=document.createElement("li");
      li.className = t.done ? "done" : "";

      const cb=document.createElement("input");
      cb.type="checkbox";
      cb.checked=!!t.done;
      cb.onchange=()=>{
        t.done=cb.checked;
        save();
      };

      const span=document.createElement("span");
      span.textContent=t.text;

      li.append(cb,span);
      el.list.appendChild(li);
    });
  }

  async function save(){
    saving = true;
    setState("wait", "â¬†ï¸ åŒæœŸï¼šä¿å­˜ä¸­â€¦");
    const r = await remoteSet(KEY_TASKS, tasks);
    if(r && r.ok){
      toast("å…±æœ‰ä¿å­˜OK");
      lastSig = sigOf(tasks);
      lastOkAt = Date.now();
      setState("ok", "âœ… åŒæœŸï¼šOK");
    }else{
      toast("ä¿å­˜å¤±æ•—ï¼š" + (r?.error || "unknown"));
      setState("ng", "âš ï¸ åŒæœŸï¼šå¤±æ•—");
    }
    saving = false;
    render();
  }

  async function syncOnce(label=false){
    if(saving) return; // ä¿å­˜ä¸­ã¯åæ˜ ã—ãªã„ï¼ˆä¸Šæ›¸ãäº‹æ•…é˜²æ­¢ï¼‰
    try{
      if(label) setState("wait", "â¬‡ï¸ åŒæœŸï¼šèª­ã¿è¾¼ã¿ä¸­â€¦");
      const r = await remoteGet(KEY_TASKS);
      if(Array.isArray(r)){
        const sig = sigOf(r);
        if(sig !== lastSig){
          tasks = r;
          lastSig = sig;
          render();
        }
        lastOkAt = Date.now();
        if(label) setState("ok", "âœ… åŒæœŸï¼šOK");
        else {
          // è‡ªå‹•ãƒãƒ¼ãƒªãƒ³ã‚°æ™‚ã¯è¡¨ç¤ºã‚’ã†ã‚‹ã•ãã—ãªã„ï¼ˆãŸã¾ã«OKã«ã™ã‚‹ï¼‰
          if(Date.now() - lastOkAt < 2500) setState("ok", "âœ… åŒæœŸï¼šOK");
        }
      }else{
        if(label) setState("ng", "âš ï¸ åŒæœŸï¼šãƒ‡ãƒ¼ã‚¿ãªã—");
      }
    }catch(e){
      if(label) setState("ng", "âš ï¸ åŒæœŸï¼šé€šä¿¡ã‚¨ãƒ©ãƒ¼");
    }
  }

  document.getElementById("addBtn").onclick=()=>{
    const v=el.input.value.trim();
    if(!v) return;
    tasks.unshift({id:Date.now(),text:v,done:false});
    el.input.value="";
    render();   // ç”»é¢ã¯å³åæ˜ 
    save();     // è£ã§ä¿å­˜
  };

  document.getElementById("resetBtn").onclick=()=>{
    if(!confirm("å…¨éƒ¨ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ"))return;
    tasks=[];
    render();
    save();
  };

  document.getElementById("syncBtn").onclick=()=>syncOnce(true);

  // init
  (async()=>{
    setState("wait","â¬‡ï¸ åŒæœŸï¼šåˆå›èª­ã¿è¾¼ã¿â€¦");
    await syncOnce(true);
    render();

    // â˜…è‡ªå‹•ãƒãƒ¼ãƒªãƒ³ã‚°ï¼ˆ2ç§’ï¼‰
    setInterval(()=>syncOnce(false), 2000);
  })();
})();
</script>
</body>
</html>
